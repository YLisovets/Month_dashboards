---
title: "Звіт з асортименту за `r lubridate::month(lubridate::rollback(Sys.Date()), label = TRUE, abbr = FALSE)`"
output: 
  flexdashboard::flex_dashboard:
    logo: "data/logo.png"
    css: "custom.css"
    orientation: rows
    vertical_layout: scroll
    theme:
      version: 4
      primary: "red"
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(plotly)
library(reactablefmtr)
library(timetk)
library(viridis)
library(htmltools)

library(DBI)
library(odbc)
library(dbplyr)
```

```{r preparation}
source("global.R", local = FALSE)

con <- connect_to_db()

get_references()

date_start <-  rollback(Sys.Date(), roll_to_first = TRUE) - months(1) #as.Date("2022-02-01")
date_finish <- date_start + months(1)
reporting_month <- month(date_start, label = TRUE)
date_start_year <- floor_date(date_start,unit = "year")
date_start_report <- if_else(month(date_start) == 1,
                            date_start - months(13),
                            date_start_year - years(1))

sale_df <- tibble(start_month = seq.Date(date_start_report, date_start,
                                             by = "month"),
                  end_month   = seq.Date(date_start_report + months(1),
                                             date_finish,
                                             by = "month")) %>% 
    mutate(sale = map2(start_month + years(2000), end_month + years(2000),
                       sale_data_total)) %>% 
    unnest(cols = sale) %>% 
    group_by(start_month, subdiv_id, store_id, item_id) %>% 
    summarise(sale_sum = sum(item_sum, na.rm = TRUE) +
                             sum(item_vat, na.rm = TRUE),
              item_qty = sum(item_qty, na.rm = TRUE)) %>% 
    ungroup()

cost_df <- tibble(start_month = seq.Date(date_start_report, date_start,
                                               by = "month"),
                  end_month   = seq.Date(date_start_report + months(1),
                                               date_finish,
                                               by = "month")) %>% 
    mutate(cost = map2(start_month + years(2000), end_month + years(2000),
                       cost_data)) %>% 
    unnest(cols = cost) %>% 
    group_by(start_month, subdiv_id, store_id, item_id) %>% 
    summarise(cost_sum = sum(item_sum, na.rm = TRUE) +
                             sum(item_vat, na.rm = TRUE)) %>% 
    ungroup()

inventory_df <- tibble(date = seq.Date(date_start_report, date_finish,
                                       by = "month")) %>% 
    mutate(inventory = map(date + years(2000), inventory_data)) %>% 
    unnest(cols = inventory)

# write_rds(inventory_df, "data/inventory_df.rds")
# inventory_df <- read_rds("data/inventory_df.rds")


var_summary <- function(data, var) {
    data %>% 
        group_by(month) %>% 
        summarise(sum = sum({{ var }})) %>% 
        pull(sum)
        
}


otif_fn <- function(date_start, date_finish) {
    
    closing_supplier_order_data <- closing_supplier_order(date_start + years(2000),
                                                      date_finish + years(2000)) %>%
    filter(date_supplier_order >= date_start + years(2000) - months(1))


    closing_orders_previos_month_orders <- closing_supplier_order_data %>% 
        filter(date_supplier_order < date_start + years(2000)) %>% 
        select(nmbr_supplier_order, date_supplier_order)

    closing_orders_purch_previos <- purchases_data(date_start + years(2000) -
                                                       months(1),
                                                   date_finish + years(2000) -
                                                       months(1)) %>% 
    filter(str_detect(contract_name, "^685", negate = TRUE), 
           !is.na(order_nmbr)) %>% 
        distinct(doc_purch_nmbr, order_nmbr, order_date) %>%
        semi_join(closing_orders_previos_month_orders,
                  by = c("order_nmbr" = "nmbr_supplier_order",
                         "order_date" = "date_supplier_order"))
          
    closing_supplier_order_df <- closing_supplier_order_data %>% 
        anti_join(closing_orders_purch_previos,
                  by = c("nmbr_supplier_order" = "order_nmbr",
                         "date_supplier_order" = "order_date"))

    supplier_order_in_purchases_data <- purchases_data(date_start + years(2000),
                                                       date_finish +
                                                           years(2000)) %>% 
    filter(str_detect(contract_name, "^685", negate = TRUE), 
           !is.na(order_nmbr)) 


    total_purchases_qty <- sum(supplier_order_in_purchases_data$item_qty)

    total_purchases_qty_suppliers <- supplier_order_in_purchases_data %>% 
        group_by(supplier_id) %>% 
        summarise(suppl_qty = sum(item_qty))

    supplier_order_in_purchases <- supplier_order_in_purchases_data %>% 
        distinct(order_nmbr, order_date)

    total_supplier_orders <- supplier_order_in_purchases %>% 
        union(select(closing_supplier_order_df, order_nmbr = nmbr_supplier_order,
                     order_date = date_supplier_order)) %>% 
        mutate(supplier_order_doc = paste0(order_nmbr, " / ",
                                           order_date))

    min_order_date <- as.Date(min(total_supplier_orders$order_date))
    max_order_date <- as.Date(max(total_supplier_orders$order_date))

    supplier_orders_vec <- pull(total_supplier_orders, supplier_order_doc)


    suppliers_orders_raw <- supplier_order_data(min_order_date,
                                                max_order_date + days(1)) %>% 
        select(nmbr_supplier_order, date_supplier_order, supplier_id, item_id, 
               item_qty, date_receipt) %>% 
        mutate(supplier_order_doc = paste0(nmbr_supplier_order, " / ",
                                           date_supplier_order)) %>% 
        filter(supplier_order_doc %in% supplier_orders_vec)

    suppliers_orders_main_data <- suppliers_orders_raw %>% 
        distinct(nmbr_supplier_order, date_supplier_order, date_receipt)

    total_orders_qty <- sum(suppliers_orders_raw$item_qty)

    in_full_suppliers <- suppliers_orders_raw %>% 
        group_by(supplier_id) %>% 
        summarise(suppl_orders_qty = sum(item_qty)) %>% 
        left_join(total_purchases_qty_suppliers, by = c("supplier_id")) %>% 
        mutate(in_full = ifelse(is.na(suppl_qty), 
                                0,
                                round(suppl_qty / suppl_orders_qty, 3)))

    total_in_full <- round(total_purchases_qty / total_orders_qty, 3)

    on_time_suppliers <- supplier_order_in_purchases_data %>% 
        left_join(suppliers_orders_main_data,
                  by = c("order_nmbr" = "nmbr_supplier_order",
                         "order_date" = "date_supplier_order")) %>% 
        mutate(on_time_flag = ifelse(as.Date(date) <= date_receipt,
                                     1,
                                     0)) %>% 
        group_by(supplier_id) %>% 
        summarise(total_qty = sum(item_qty),
                  on_time_qty = sum(item_qty[on_time_flag == 1], na.rm = TRUE),
                  on_time = round(on_time_qty / total_qty, 3))

    total_on_time <- round(sum(on_time_suppliers $on_time_qty) / 
                               sum(on_time_suppliers $total_qty),
                           3)
    
    return(list(total_on_time, total_in_full, in_full_suppliers,
                on_time_suppliers))
    
}

required_hierarchy_level_group <- function(items_id, level = 3L) {
    item_df <- items_id
    current_rec <- left_join(item_df,
                             select(ref_items, item_id, group_id)) 
    i <- 1
    row_qty <- nrow(current_rec)
    while(sum(is.na(current_rec[, ncol(current_rec)])) != row_qty) {
        prev_parent <- current_rec
        current_rec <- left_join(prev_parent,
                                 select(ref_item_group, group_id,  parent_group))
        names(current_rec)[ncol(current_rec) - 1] <- str_glue("group_level_{i}")
        names(current_rec)[ncol(current_rec)] <- "group_id"
        i <- i + 1
    }
    
    res <- current_rec %>% 
        mutate(last_non_na = max.col(!is.na(current_rec), ties.method = "last"),
               nmbr_col = ifelse(last_non_na > level + 1,
                                 last_non_na - level,
                                 2)) %>% 
        group_by(row_number()) %>% 
        mutate(lev_group = cur_data()[[nmbr_col]]) %>% 
        ungroup() %>% 
        select(item_id, lev_group)
    
    return(res)
}


shop_category <- ref_shops %>% 
    select(subdiv_name, shop_cat = parent_shop) %>% 
    distinct(subdiv_name, .keep_all = TRUE) %>% 
    mutate(subdiv_name = str_replace(subdiv_name, " сервіс", ""),
           subdiv_name = str_replace(subdiv_name, " Сервіс", ""),
           subdiv_name = str_replace(subdiv_name, " Роздріб", ""),
           subdiv_name = str_replace(subdiv_name, " роздріб", ""))

shop_store <- ref_store %>% 
    arrange(store_id) %>% 
    select(store_id, store_subdiv = subdiv_name) %>% 
    distinct(store_subdiv, .keep_all = TRUE) %>% 
    mutate(store_subdiv = str_replace(store_subdiv, " Роздріб", ""),
           store_subdiv = str_replace(store_subdiv, " роздріб", ""))

planogram_raw <- planogram_data(date_finish + years(2000))

tva_start <- tva_data(date_start + years(2000))
tva_finish <- tva_data(date_finish + years(2000))

norm_data <- get_norm(date_finish + years(2000))

face_data <- get_face(date_finish + years(2000))

active_sku_start_data <- get_face(date_start + years(2000)) %>%
    filter(!item_id %in% tva_finish,
           face_qty > 0)
```

```{r main_indicator}
inventory_category <- inventory_df %>% 
    left_join(select(ref_items, item_id, group_id),
                  by = "item_id") %>% 
        left_join(select(ref_item_group, group_id, category_name,
                         category_manager),
                  by = "group_id") %>%
    filter(!is.na(category_name)) %>% 
    group_by(date, category_name, category_manager) %>% 
    summarise(cat_inventory = sum(total_item_sum, na.rm = TRUE)) %>% 
    ungroup()

inventory_cat_month <- inventory_category %>%
    filter(date >= date_finish - months(12)) %>% 
    arrange(date) %>% 
    group_by(category_name, category_manager) %>% 
    tk_augment_slidify(
                 .value   = cat_inventory,
                 .f       = ~ mean(., na.rm = TRUE),
                 .period  = 2,
                 .align   = "right",
                 .partial = TRUE,
                 .names   = "inv_ma"
             ) %>% 
    ungroup() %>%
    filter(date >= date_finish - months(12) + months(1)) %>% 
    mutate(month_finish = date - months(1)) %>% 
    select(month_finish, category_name, category_manager, inv_ma)
    

inventory_cat_12month <- inventory_category %>% 
    filter(cat_inventory > 100) %>% 
    arrange(date) %>% 
    group_by(category_name, category_manager) %>% 
    tk_augment_slidify(
                 .value   = cat_inventory,
                 .f       = ~ mean(., na.rm = TRUE),
                 .period  = 13,
                 .align   = "right",
                 .partial = TRUE,
                 .names   = "inv_ma"
             ) %>% 
    ungroup() %>% 
    filter(date >= date_start_report + months(13)) %>% 
    mutate(month_finish = date - months(1)) %>% 
    select(month_finish, category_name, category_manager, inv_ma)


sale_category_data <- sale_df %>% 
    left_join(select(ref_items, item_id, group_id),
                  by = "item_id") %>% 
    left_join(select(ref_item_group, group_id, category_name, category_manager),
                  by = "group_id") %>%
    group_by(start_month, category_name, category_manager) %>% 
    summarise(cat_sale_sum = sum(sale_sum)) %>% 
    ungroup() %>% 
    filter(!is.na(category_name))

cost_category_data <- cost_df %>% 
    left_join(select(ref_items, item_id, group_id),
                  by = "item_id") %>% 
    left_join(select(ref_item_group, group_id, category_name, category_manager),
                  by = "group_id") %>%
    group_by(start_month, category_name, category_manager) %>% 
    summarise(cat_cost_sum = sum(cost_sum)) %>%
    ungroup() %>% 
    filter(!is.na(category_name))
    
profit_category_data <- sale_category_data %>% 
    left_join(cost_category_data, 
              by = c("start_month", "category_name", "category_manager")) %>% 
    mutate(cat_profit = cat_sale_sum - cat_cost_sum,
           category = paste0(category_name, "/", category_manager))

gmroi_category_12month <- profit_category_data %>% 
    filter(cat_profit > 10) %>% 
    #select(-c(cat_sale_sum, cat_cost_sum)) %>% 
    arrange(start_month) %>% 
    group_by(category) %>% 
    tk_augment_slidify(
                 .value   = c(cat_sale_sum, cat_cost_sum, cat_profit),
                 .f       = ~ sum(., na.rm = TRUE),
                 .period  = 12,
                 .align   = "right",
                 .partial = TRUE,
                 .names   = c("sale_year", "cost_year", "profit_year")
             ) %>% 
    ungroup() %>% 
    filter(start_month >= date_start_report + months(12)) %>%
    left_join(inventory_cat_12month,
              by = c("start_month" = "month_finish",
                     "category_name", "category_manager")) %>%
    mutate(gmroi = round(profit_year / inv_ma, 2),
           month = month(start_month, label = TRUE)) %>% 
    filter(!is.na(category_name))

total_gmroi_category_12month <- tibble(
    month = unique(gmroi_category_12month$start_month),
    cost_year = var_summary(gmroi_category_12month, cost_year),
    profit_year = var_summary(gmroi_category_12month, profit_year),
    inv_ma = var_summary(gmroi_category_12month, inv_ma),
    gmroi = round(profit_year / inv_ma, 2),
    category = rep("Загальний", times = length(month))
)  
    
gmroi_category_12month_df <- gmroi_category_12month %>% 
    filter(!str_detect(category, "15. Копіцентр")) %>%
    select(month = start_month, category, profit_year, inv_ma, gmroi) %>% 
    bind_rows(select(total_gmroi_category_12month, -cost_year)) %>% 
    mutate(category = str_replace(category, "[:space:][:alpha:]+$", ""),
           category = str_replace(category,
                                  "Прибирання(.*?)(?=/)", "Прибирання"),
           category = str_replace(category, "Шкільн(і|а|ий)[:space:]", "Шк."),
           category = str_replace(category, "Успішний ", "Усп."),
           category = str_replace(category, "Зручність і лайфстайл",
                                  "Зручність"))

max_gmroi_categories <- gmroi_category_12month_df %>% 
    filter(month == date_start) %>%
    slice_max(gmroi, n=3) %>% 
    pull(category)
min_gmroi_categories <- gmroi_category_12month_df %>% 
    filter(month == date_start) %>%
    slice_min(gmroi, n=3) %>% 
    pull(category)
highlights <- c(max_gmroi_categories, "Загальний", min_gmroi_categories)

gmroi_category_12_month_plot <- gmroi_category_12month_df %>% 
    arrange(month, gmroi) %>% 
    group_by(category) %>% 
    mutate(group = if_else(category %in% highlights, category, "Інші"),
           group = as.factor(group)) %>%
    ungroup() %>% 
    mutate(group = fct_relevel(group, c(max_gmroi_categories,
                                        "Загальний",
                                        rev(min_gmroi_categories),
                                        "Інші")),
           month = format(month, "%m-%y"))

fig2 <- gmroi_category_12_month_plot %>%
    group_by(category) %>% 
    plot_ly(x=~month,  y=~gmroi,
            color =~ group, colors = c("darkgreen", "seagreen3", "greenyellow",
                                       "royalblue4", "tan1", "tomato", "red4",
                                       "grey"),
            type = "scatter", mode = "markers+lines",
            text =~ paste0(category, ": ", gmroi), hoverinfo = "text") %>% 
    layout(xaxis = list(title = ""),
           yaxis = list(title = ""))



gmroi_category_month_data <- profit_category_data %>% 
    filter(start_month >= date_finish - months(12)) %>%
    left_join(inventory_cat_month,
              by = c("start_month" = "month_finish",
                     "category_name", "category_manager")) %>%
    mutate(gmroi = round(cat_profit / inv_ma, 2),
           month = month(start_month, abbr = TRUE)) %>% 
    arrange(month)

total_gmroi_category_month <- tibble(
    month = unique(gmroi_category_month_data$start_month),
    cat_cost = var_summary(gmroi_category_month_data, cat_cost_sum),
    cat_profit = var_summary(gmroi_category_month_data, cat_profit),
    inv_ma = var_summary(gmroi_category_month_data, inv_ma),
    gmroi = round(cat_profit / inv_ma, 2),
    category = rep("Загальний", times = length(month))
)  
    
gmroi_category_month_df <- gmroi_category_month_data %>% 
    select(month = start_month, category, cat_profit, inv_ma, gmroi) %>%
    bind_rows(select(total_gmroi_category_month, -cat_cost))

gmroi_current_month <- gmroi_category_month_df$gmroi[
    gmroi_category_month_df$month == date_start &
    gmroi_category_month_df$category == "Загальний"]

fig1 <- gmroi_category_month_df %>% 
    mutate(label_text = str_glue("GMROI: {gmroi}")) %>%
    filter(category == "Загальний") %>% 
    ggplot(aes(x = month, y = gmroi, group = 1)) + 
    geom_line(size = 1.5, color = "steelblue") +
    geom_point(aes(text = label_text), shape = 21, size = 3, fill = "steelblue") +
    scale_x_date(date_breaks = '2 months', 
                 date_labels = "%b-%y") +
    theme_minimal() +
    labs(y = "",
         x = "",
         title = "")


sale_current_month <- sale_df %>% 
    filter(!item_id %in% c("000532240",         # в Скарбничку
                           "000520253",         # Відшкодування по інвентаризації
                           "000000228",         # Доставка товару
                           "000500027"),        # бонус
           start_month == date_start) %>%
    left_join(select(ref_subdiv, subdiv_id, subdiv_store = store_id, subdiv_name),
              by = "subdiv_id") %>% 
    filter(store_id == subdiv_store) %>% 
    left_join(shop_store, by = "store_id") %>% 
    left_join(shop_category, by = c("store_subdiv" = "subdiv_name")) %>% 
    filter(!is.na(shop_cat)) %>%
    left_join(select(ref_items, item_id, group_id),
              by = "item_id") %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager),
              by = "group_id") %>%
    filter(group_id != "000003589")

cost_current_month <- cost_df %>% 
    filter(!item_id %in% c("000532240",         # в Скарбничку
                           "000520253",         # Відшкодування по інвентаризації
                           "000000228",         # Доставка товару
                           "000500027"),        # бонус
           start_month == date_start,
           cost_sum > 0) %>%
    left_join(select(ref_subdiv, subdiv_id, subdiv_store = store_id, subdiv_name),
              by = "subdiv_id") %>% 
    filter(store_id == subdiv_store) %>%
    left_join(shop_store, by = "store_id") %>% 
    left_join(shop_category, by = c("store_subdiv" = "subdiv_name")) %>% 
    filter(!is.na(shop_cat)) %>%
    left_join(select(ref_items, item_id, group_id),
              by = "item_id") %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager),
              by = "group_id") %>%
    filter(group_id != "000003589")

inventory_current_month <- inventory_df %>% 
    filter(!item_id %in% c("000532240",         # в Скарбничку
                           "000520253",         # Відшкодування по інвентаризації
                           "000000228",         # Доставка товару
                           "000500027"),        # бонус
           date >= date_start) %>%
    left_join(shop_store, by = "store_id") %>% 
    left_join(select(ref_items, item_id, group_id),
              by = "item_id") %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager),
              by = "group_id") %>%
    filter(group_id != "000003589")

sale_current_month_subdiv <- sale_current_month %>% 
    group_by(store_subdiv) %>% 
    summarise(subdiv_sale = sum(sale_sum))

cost_current_month_subdiv <- cost_current_month %>% 
    group_by(store_subdiv) %>% 
    summarise(subdiv_cost = sum(cost_sum))

inventory_current_month_subdiv <- inventory_current_month %>% 
    filter(!is.na(store_subdiv)) %>%
    group_by(store_subdiv, date) %>% 
    summarise(inventory_sum = sum(total_item_sum)) %>% 
    group_by(store_subdiv) %>% 
    summarise(avr_inventory = sum(inventory_sum))

gmroi_subdiv_df <- sale_current_month_subdiv %>% 
    left_join(cost_current_month_subdiv, by = "store_subdiv") %>% 
    replace_na(list(subdiv_cost = 0)) %>% 
    mutate(subdiv_profit = subdiv_sale - subdiv_cost) %>% 
    left_join(inventory_current_month_subdiv, by = "store_subdiv") %>% 
    mutate(gmroi = round(subdiv_profit / avr_inventory, 2)) %>% 
    left_join(shop_category, by = c("store_subdiv" = "subdiv_name"))


sale_store_category <- sale_current_month %>% 
    filter(!is.na(category_name)) %>% 
    mutate(category = paste0(category_name, "/", category_manager)) %>%
    group_by(store_subdiv, category) %>% 
    summarise(subdiv_sale = sum(sale_sum)) %>% 
    ungroup()
    

cost_store_category <- cost_current_month %>% 
    filter(!is.na(category_name)) %>%
    mutate(category = paste0(category_name, "/", category_manager)) %>%
    group_by(store_subdiv, category) %>% 
    summarise(subdiv_cost = sum(cost_sum)) %>% 
    ungroup()

inventory_store_category <- inventory_current_month %>% 
    filter(!is.na(store_subdiv),
           !is.na(category_name)) %>%
    mutate(category = paste0(category_name, "/", category_manager)) %>%
    group_by(date, store_subdiv, category) %>% 
    summarise(inventory_sum = sum(total_item_sum, na.rm = TRUE)) %>% 
    group_by(store_subdiv, category) %>%
    summarise(avr_inventory = mean(inventory_sum)) %>% 
    ungroup() %>%
    filter(!str_detect(category, "15. Копіцентр"),
           !str_detect(category, "08. Стільці та крісла"),
           !str_detect(category, "09. Меблі в офіс")) %>% 
    semi_join(shop_category, by = c("store_subdiv" = "subdiv_name"))

gmroi_subdiv_category <- sale_store_category %>% 
    filter(!str_detect(category, "15. Копіцентр"),
           !str_detect(category, "08. Стільці та крісла"),
           !str_detect(category, "09. Меблі в офіс")) %>%
    left_join(cost_store_category, by = c("store_subdiv", "category")) %>% 
    replace_na(list(subdiv_cost = 0)) %>% 
    mutate(subdiv_profit = subdiv_sale - subdiv_cost) %>% 

    full_join(inventory_store_category,
              by = c("store_subdiv" ,"category")) %>%
    mutate(across(where(is.numeric), replace_na, 0)) %>%
    filter(!(subdiv_profit == 0 & avr_inventory < 100),
           avr_inventory > 0) %>% 
    mutate(gmroi = round(subdiv_profit / avr_inventory, 2)) %>% 
    arrange(desc(store_subdiv))

fig3 <- gmroi_subdiv_category %>% 
    plot_ly(x =~ category, 
            y =~ store_subdiv,
            z =~ gmroi,
            type = "heatmap",
            colorbar = list(title = ""),
            hovertemplate = 'КН/КМ: %{x} <br> Підрозділ: %{y} <br> GMROI: %{z} <extra></extra>'
    ) %>% 
    layout(xaxis = list(showticklabels = FALSE, title = ""),
           yaxis = list(title = "", tickfont = list(size = 7))) 


inventory_turnover_month <- gmroi_category_month_data %>% 
    select(month = start_month, category, cat_cost_sum, inv_ma) %>%
    bind_rows(select(total_gmroi_category_month, month, cat_cost_sum = cat_cost,
                     inv_ma, category)) %>% 
    mutate(days_in_month = as.integer(ceiling_date(month, unit = "month") -
                                          month)) %>% 
    mutate(turnover = round(inv_ma / cat_cost_sum * days_in_month))

inventory_turnover_current_month <- inventory_turnover_month$turnover[
    inventory_turnover_month$month == date_start &
    inventory_turnover_month$category == "Загальний"]

fig4 <- inventory_turnover_month %>% 
    mutate(label_text = str_glue("Період обороту: {turnover}")) %>%
    filter(category == "Загальний") %>% 
    ggplot(aes(x = month, y = turnover, group = 1)) + 
    geom_line(linewidth = 1.5, color = "steelblue") +
    geom_point(aes(text = label_text), shape = 21, size = 3, fill = "steelblue") +
    scale_x_date(date_breaks = '2 months', 
                 date_labels = "%b-%y") +
    theme_minimal() +
    labs(y = "",
         x = "",
         title = "")

inventory_turnover_12month <- gmroi_category_12month %>% 
    select(month = start_month, category, cost_year, inv_ma) %>% 
    filter(!str_detect(category, "15. Копіцентр")) %>%
    bind_rows(select(total_gmroi_category_12month,
                     -profit_year, -gmroi)) %>% 

    mutate(turnover = round(inv_ma / cost_year * 360),
           category = str_replace(category, "[:space:][:alpha:]+$", ""),
           category = str_replace(category,
                                  "Прибирання(.*?)(?=/)", "Прибирання"),
           category = str_replace(category, "Шкільн(і|а|ий)[:space:]", "Шк."),
           category = str_replace(category, "Успішний ", "Усп."),
           category = str_replace(category, "Зручність і лайфстайл",
                                  "Зручність")) %>% 
    filter(turnover < 500)

max_turnover_categories <- inventory_turnover_12month %>% 
    filter(month == date_start) %>%
    slice_max(turnover, n=3) %>% 
    pull(category)
min_turnover_categories <- inventory_turnover_12month %>% 
    filter(month == date_start) %>%
    slice_min(turnover, n=3) %>% 
    pull(category)
highlights_turnover <- c(max_turnover_categories, "Загальний",
                         min_turnover_categories)

inventory_turnover_12month_plot <- inventory_turnover_12month %>% 
    arrange(month, turnover) %>% 
    group_by(category) %>% 
    mutate(group = if_else(category %in% highlights_turnover,
                           category,
                           "Інші"),
           group = as.factor(group)) %>% 
    ungroup() %>% 
    mutate(group = fct_relevel(group, c(max_turnover_categories,
                                        "Інші",
                                        "Загальний",
                                        rev(min_turnover_categories)
                                        ))) %>% 
    mutate(month = format(month, "%m-%y"))


fig5 <- inventory_turnover_12month_plot %>%
    group_by(category) %>% 
    plot_ly(x=~month,  y=~turnover,
            color =~ group, colors = c("red4", "tomato", "tan1",
                                       "grey", "royalblue4",
                                       "greenyellow", "seagreen3", "darkgreen"),
            type = "scatter", mode = "markers+lines",
            text =~ paste0(category, ": ", turnover), hoverinfo = "text") %>% 
    layout(xaxis = list(title = ""),
           yaxis = list(title = ""))


turnover_subdiv_df <- gmroi_subdiv_df %>% 
    mutate(turnover = round(avr_inventory / subdiv_cost *
                                as.integer(date_finish - date_start)))

# turnover_subdiv_category <- gmroi_subdiv_category %>% 
#     mutate(turnover = ifelse(subdiv_cost == 0,
#                              3500,
#                              round(avr_inventory / subdiv_cost *
#                                    as.integer(date_finish - date_start)))) %>% 
#     arrange(desc(store_subdiv))
# 
# fig6 <- turnover_subdiv_category %>% 
#     plot_ly(x =~ category, 
#             y =~ store_subdiv,
#             z =~ turnover,
#             colorbar = list(title = ""),
#             type = "heatmap",
#             hovertemplate = 'КН/КМ: %{x} <br> Підрозділ: %{y} <br> Період обороту: %{z} <extra></extra>'
#     ) %>% 
#     layout(xaxis = list(title = "", showticklabels = FALSE),
#            yaxis = list(title = "", tickfont = list(size = 7)))


items_3lev_group <- sale_current_month %>% 
    distinct(item_id) %>% 
    required_hierarchy_level_group() %>% 
    left_join(select(ref_item_group, group_id, lev_group_name = group_name),
              by = c("lev_group" = "group_id"))

sale_current_month_group <- sale_current_month %>% 
    group_by(item_id) %>% 
    summarise(item_sum = sum(sale_sum)) %>% 
    left_join(items_3lev_group, by = "item_id") %>% 
    group_by(lev_group) %>% 
    summarise(group_sum = sum(item_sum))

cost_current_month_group <- cost_current_month %>% 
    group_by(item_id) %>% 
    summarise(item_cost = sum(cost_sum)) %>% 
    left_join(items_3lev_group, by = "item_id") %>% 
    group_by(lev_group) %>% 
    summarise(group_cost = sum(item_cost))

inventory_current_month_group <- inventory_current_month %>% 
    group_by(date, item_id) %>% 
    summarise(item_inventory = sum(total_item_sum)) %>% 
    left_join(items_3lev_group, by = "item_id") %>% 
    group_by(date, lev_group) %>% 
    summarise(group_inventory = sum(item_inventory)) %>% 
    filter(!is.na(lev_group)) %>% 
    group_by(lev_group) %>% 
    tk_augment_slidify(
                 .value   = group_inventory,
                 .f       = ~ mean(., na.rm = TRUE),
                 .period  = 2,
                 .align   = "right",
                 .partial = TRUE,
                 .names   = "inv_ma"
             ) %>% 
    ungroup() %>% 
    filter(date == date_finish) %>% 
    select(-group_inventory, -date)

group_gmroi <- sale_current_month_group %>% 
    left_join(cost_current_month_group) %>% 
    full_join(inventory_current_month_group) %>% 
    mutate(across(where(is.numeric), replace_na, 0),
           group_profit = round((group_sum - group_cost)/1000, 1),
           inv_ma = round(inv_ma / 1000, 1),
           group_gmroi = round(group_profit / inv_ma, 2)) %>% 
    filter(inv_ma != 0,
           !lev_group %in% "000001912")   # Бонус

fig6 <- group_gmroi %>% 
    left_join(select(ref_item_group, group_id, group_name),
              by = c("lev_group" = "group_id")) %>% 
    mutate(label_text = str_glue("Ном.группа: {group_name}
                                  Вал.прибуток: {group_profit}
                                  Сер.залишки: {inv_ma}
                                  GMROI: {group_gmroi}"),
           type = ifelse(group_profit < inv_ma * gmroi_current_month,
                         0,
                         1),
           type = as.factor(type)) %>% 
    ggplot(aes(x = inv_ma, y = group_profit)) +
    scale_x_continuous(n.breaks = 6,
                       labels = scales::comma) +
    scale_y_continuous(n.breaks = 5,
                       labels = scales::comma) +
    geom_point(aes(text = label_text, color = type), alpha = 0.4, size = 2) + 
    scale_color_manual(values = c("#EE865D", "#59BEC4")) +
    geom_abline(intercept = 0, slope = gmroi_current_month,
                color = "red", linetype = "dashed", size = 1) +
    annotate("text", x = 3500, y = 820, label = "Загальний GMROI",
             color = "red") +
    labs (y = "Валовий прибуток, тис.грн",
          x = "Середні залишки, тис.грн",
          title = "Аналіз номенклатурних груп") +
    theme_minimal() +
    theme(legend.position = "none")

rm(inventory_cat_12month, gmroi_category_12month, total_gmroi_category_12month,
   inventory_cat_month, profit_category_data, gmroi_category_12month_df,
   inventory_current_month, inventory_store_category, gmroi_subdiv_category,
   inventory_turnover_12month, turnover_subdiv_category)
```


```{r planogram_analysis}
active_shelf <- ref_shelf %>% 
    filter(active == TRUE)

total_store_shelf_space <- planogram_raw %>% 
    distinct(shelf_id, shelving_id, store_id) %>% 
    left_join(select(active_shelf, shelf_id, shelving_id, store_id,
                     width, height, depth),
              by = c("store_id", "shelving_id", "shelf_id")) %>% 
    group_by(store_id, shelf_id) %>% 
    summarise(shelf_vol = width * height * depth / (100*100*100)) %>% 
    ungroup() %>% 
    group_by(store_id) %>% 
    summarise(store_vol = sum(shelf_vol, na.rm = TRUE))

total_shelf_space <- round(sum(total_store_shelf_space$store_vol),1)

items_space_data <- planogram_raw %>% 
    left_join(select(active_shelf, shelf_id, shelving_id, store_id,
                     shelf_height = height, shelf_depth = depth),
              by = c("store_id", "shelving_id", "shelf_id")) %>%
    filter(!is.na(shelf_height)) %>% 
    left_join(select(ref_items, item_id, group_id, item_width = width, 
                     item_depth = depth, item_height = height)) %>%
    mutate(item_space = facing * (item_width / 10 * shelf_height * shelf_depth)/
                                 (100*100*100))

chairs_store_space <- items_space_data %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager)) %>%
    filter(category_name %in% "08. Стільці та крісла ") %>% 
    mutate(item_space = item_width * item_depth / (1000*1000)) %>% 
    group_by(store_id, category_name, category_manager) %>% 
    summarise(store_cat_volume = sum(item_space) * max(item_height)/1000) %>% 
    ungroup()

cat_store_space <- items_space_data %>% 
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager)) %>% 
    filter(!category_name %in% "08. Стільці та крісла ") %>%
    group_by(store_id, category_name, category_manager) %>% 
    summarise(store_cat_volume = sum(item_space, na.rm = TRUE)) %>% 
    ungroup() %>% 
    bind_rows(chairs_store_space)

total_active_shelf_space <- round(sum(cat_store_space$store_cat_volume), 1)

total_sale <- sum(gmroi_category_month_data$cat_sale_sum[
        gmroi_category_month_data$start_month == date_start]) -
    # gmroi_category_month_data$cat_sale_sum[
    #     gmroi_category_month_data$start_month == date_start &
    #      str_detect(gmroi_category_month_data$category,
    #         "08. Стільці та крісла")] - 
    # gmroi_category_month_data$cat_sale_sum[
    #     gmroi_category_month_data$start_month == date_start &
    #         str_detect(gmroi_category_month_data$category,
    #                    "09. Меблі в офіс")] -
    gmroi_category_month_data$cat_sale_sum[
        gmroi_category_month_data$start_month == date_start &
            str_detect(gmroi_category_month_data$category,
                       "15. Копіцентр")]

total_profit <- sum(gmroi_category_month_data$cat_profit[
        gmroi_category_month_data$start_month == date_start]) -
    # gmroi_category_month_data$cat_profit[
    #     gmroi_category_month_data$start_month == date_start &
    #      str_detect(gmroi_category_month_data$category,
    #         "08. Стільці та крісла")] - 
    # gmroi_category_month_data$cat_profit[
    #     gmroi_category_month_data$start_month == date_start &
    #         str_detect(gmroi_category_month_data$category,
    #                    "09. Меблі в офіс")] -
    gmroi_category_month_data$cat_profit[
        gmroi_category_month_data$start_month == date_start &
            str_detect(gmroi_category_month_data$category,
                       "15. Копіцентр")] 

cat_sale_share <- gmroi_category_month_data %>% 
    filter(start_month == date_start) %>% 
    select(category, cat_sale_sum, cat_profit) %>% 
    mutate(sale_share = round(cat_sale_sum / total_sale, 4),
           profit_share = round(cat_profit / total_profit, 4))

cat_space_share <- cat_store_space %>% 
    filter(!is.na(category_name)) %>% 
    mutate(category = paste0(category_name, "/", category_manager)) %>%
    group_by(category) %>% 
    summarise(cat_space = sum(store_cat_volume)) %>% 
    mutate(space_share = round(cat_space / total_shelf_space, 4)) %>% 
    left_join(select(cat_sale_share, category, sale_share, profit_share),
              by = "category") %>% 
    mutate(return_sale = round(sale_share / space_share, 2),
           return_profit = round(profit_share / space_share, 2))

fig7 <- cat_space_share %>% 
    select(category, return_sale, return_profit) %>% 
    pivot_longer(cols = return_sale:return_profit,
                 names_to = "type",
                 values_to = "value") %>% 
    filter(value < 20) %>% 
    ggplot(aes(x = value, y = category)) +
    geom_linerange(aes(xmin = ifelse(value > 1,
                                     1,
                                     value),
                       xmax = ifelse(value < 1,
                                     1,
                                     value),
                   color = type),
                   linewidth = 1.5, alpha = 0.5,
                   position = position_dodge(width = 0.6))+
    geom_point(aes(x = value, color = type), size = 3,
               position = position_dodge(width = 0.6)) +
    theme_light() + 
    scale_color_manual(labels = c('прибуток', 'продаж'),
                       values = c('forestgreen', 'gold')) +
    labs(x = '', y = '', color = '') +
    theme(legend.position = "top",
          panel.grid.major.y = element_blank(), 
          panel.border = element_blank(),
          axis.ticks.y = element_blank(),
          legend.text.align = 0.4,
          legend.spacing.x = unit(0.5, 'cm'))

cat_store_share <- cat_store_space %>% 
    mutate(category = paste0(category_name, "/", category_manager)) %>%
    group_by(store_id) %>% 
    mutate(category_share = round(store_cat_volume /
                                       sum(store_cat_volume), 3)) %>% 
    ungroup() %>% 
    left_join(shop_store, by = "store_id")

fig8 <- cat_store_share %>% 
    plot_ly(x =~ category, 
            y =~ store_subdiv, #subdiv_name,
            z =~ category_share,
            colorbar = list(title = ""),
            type = "heatmap",
            hovertemplate = 'КН/КМ: %{x} <br> Підрозділ: %{y} <br> Частка у пол.просторі: %{z} <extra></extra>'
    ) %>% 
    layout(xaxis = list(title = "", showticklabels = FALSE),
           yaxis = list(title = "", tickfont = list(size = 7)))


sale_current_month_data <- sale_current_month %>% 
    # mutate(subdiv_name = str_replace(subdiv_name, " сервіс", ""),
    #        subdiv_name = str_replace(subdiv_name, " Сервіс", ""),
    #        subdiv_name = str_replace(subdiv_name, " Роздріб", ""),
    #        subdiv_name = str_replace(subdiv_name, " роздріб", "")) %>%
    # filter(!store_id %in% c("000001064", "000001098")) %>%      # Накопители
    group_by(store_id, item_id) %>% 
    summarise(total_item_sale_qty = sum(item_qty)) %>% 
    ungroup()
    # left_join(shop_store, by = "store_id") %>% 
    # mutate(self_store_shipment = ifelse(subdiv_name == store_subdiv, 1, 0)) %>% 
    # filter(self_store_shipment == 1)


face_analysis_data <- select(face_data, -date) %>% 
    left_join(select(norm_data, -date),
              by = c("store_id", "item_id")) %>% 
    replace_na(list(norm_qty = 0)) %>%
    mutate(planogram_stock = face_qty + norm_qty) %>% 
    select(store_id, item_id, planogram_stock)

store_category_analysis <- face_analysis_data %>% 
    left_join(select(sale_current_month_data, store_id, item_id,
                     total_item_sale_qty),
              by = c("store_id", "item_id")) %>%
    replace_na(list(total_item_sale_qty = 0)) %>%
    left_join(select(ref_items, item_id, group_id),
              by = "item_id") %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager),
              by = "group_id") %>%
    filter(group_id != "000003589",
           !is.na(category_name)) %>%
    mutate(category = paste0(category_name, "/", category_manager)#,
           # planogram_turnover = round(total_item_sale_qty /
           #                                planogram_stock,
           #                            2)
           ) %>% 
    left_join(shop_store, by = "store_id") %>% 
    semi_join(shop_category, by = c("store_subdiv" = "subdiv_name")) %>% 
    group_by(store_subdiv, category) %>% 
    summarise(total_cat_items = n(),
              cat_items_without_sale = sum(total_item_sale_qty == 0),
              without_sale_share = round(cat_items_without_sale /
                                             total_cat_items,
                                         3),
              total_item_sale_qty = sum(total_item_sale_qty),
              planogram_stock = sum(planogram_stock),
              avr_planogram_turnover = round(total_item_sale_qty /
                                                 planogram_stock,
                                             2)) %>% 
    ungroup()

worst <- store_category_analysis %>%
    group_by(category) %>% 
    summarise(avr_planogram_turnover = round(sum(total_item_sale_qty) /
                                                 sum(planogram_stock),
                                             2)) %>% 
    filter(!str_detect(category, "^09.")) %>% 
    slice_min(avr_planogram_turnover)

fig9 <- store_category_analysis %>% 
    plot_ly(x =~ category, 
            y =~ store_subdiv,
            z =~ avr_planogram_turnover,
            colorbar = list(title = ""),
            type = "heatmap",
            text = ~total_cat_items,
            hovertemplate = 'КН/КМ: %{x} <br> Підрозділ: %{y} <br> Кіл.SKU: %{text} <br> Оборотність планограм: %{z} <extra></extra>'
    ) %>% 
    layout(xaxis = list(title = "", showticklabels = FALSE),
           yaxis = list(title = "", tickfont = list(size = 7)),
           title = list(text = paste0("<b>Найгірший загальний показник</b> - ",
                                      worst$category, " (",
                                      worst$avr_planogram_turnover, ")"),
                        font = list(size = 10, color = "darkred"
                                    ),
                        x = 0.05))


sale_sku_current_month_raw <- sale_current_month %>% 
    group_by(item_id) %>% 
    summarise(total_sale_qty = sum(item_qty)) %>% 
    filter(total_sale_qty > 0)

sale_price_group <- sale_sku_current_month_raw %>% 
    left_join(select(ref_items, item_id, price_group, group_id),
              by = "item_id") %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager),
              by = "group_id") %>%
    filter(!is.na(category_name)) %>% 
    mutate(category = paste0(category_name, "/", category_manager)) %>% 
    group_by(category, price_group) %>% 
    summarise(total_qty = sum(total_sale_qty)) %>%
    ungroup() %>% 
    filter(!is.na(price_group)) %>% 
    group_by(category) %>% 
    mutate("Продажі" = round(total_qty / sum(total_qty), 3)) %>% 
    ungroup()

planogram_price_group <- face_analysis_data %>% 
    left_join(select(ref_items, item_id, price_group, group_id),
              by = "item_id") %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager),
              by = "group_id") %>%
    filter(!is.na(category_name)) %>% 
    mutate(category = paste0(category_name, "/", category_manager)) %>% 
    group_by(category, price_group) %>% 
    summarise(planogram_qty = sum(planogram_stock)) %>%
    ungroup() %>% 
    group_by(category) %>% 
    mutate("Планограма" = round(planogram_qty / sum(planogram_qty), 3)) %>% 
    ungroup() %>% 
    filter(!is.na(price_group))

category_structure_plot_data <- sale_price_group %>% 
    select(-total_qty) %>% 
    left_join(select(planogram_price_group, -planogram_qty), 
              by = c("category", "price_group")) %>% 
    filter(str_detect(category, "15. Копіцентр", negate = TRUE)) %>% 
    filter(str_detect(category, "08. Стільці та крісла", negate = TRUE)) %>%
    filter(str_detect(category, "09. Меблі в офіс", negate = TRUE)) %>%
    replace_na(list("Планограма"= 0)) %>% 
    mutate(price_group = ifelse(price_group == "1Средний",
                                "Средний",
                                price_group)) %>% 
    mutate(price_group = fct_relevel(price_group,
                                     "Высокий",
                                     "Средний",
                                     "Низкий",
                                     "Entreprise")) %>% 
    pivot_longer(cols = 3:4, names_to = "type", values_to = "value") %>% 
    mutate(category = str_replace(category, "[:space:][:alpha:]+$", ""),
           category = str_replace(category,
                                  "Прибирання(.*?)(?=/)", "Прибирання"),
           category = str_replace(category, "Шкільн(і|а|ий)[:space:]", "Шк."),
           category = str_replace(category, "Успішний ", "Усп."),
           category = str_replace(category, "Зручність і лайфстайл",
                                  "Зручність"))

fig10 <- category_structure_plot_data %>% 
    ggplot(aes(x = as.factor(type),
               y = value,
               fill = price_group)) + 
    geom_bar(
             stat = "identity",
             position = position_stack()
             ) +
    scale_y_continuous(breaks = seq(0, 1, .2), 
                       label = scales::percent) +
    scale_fill_viridis(discrete = T) +
    facet_wrap(~category, ncol = 5) +
    labs(y = "Частка", 
         fill = "",
         x = "",
         title = "") +
    theme_minimal() +
    theme(legend.text = element_text(size = 8),
          axis.text.x = element_text(size = 7),
          axis.title.x = element_text(size = 8),
          axis.text.y = element_text(size = 7),
          strip.text.x = element_text(size = 5),
          legend.position = "top",
          legend.text.align = 0.3,
          legend.spacing.x = unit(0.6, 'cm'))

rm(total_store_shelf_space, items_space_data, cat_store_space, total_sale,
   total_profit, cat_sale_share, cat_space_share, cat_store_share,
   sale_current_month_data, store_category_analysis, sale_price_group,
   planogram_price_group)
```

```{r sku_analysis}
sku_inventory_start_current_month_raw <- inventory_df %>%
    filter(date == date_start) %>%
    group_by(item_id) %>% 
    summarise(total_item_qty = sum(total_item_qty),
              total_item_sum = sum(total_item_sum)) %>% 
    filter(total_item_qty > 0) %>%

    left_join(select(ref_items, item_id, group_id),
              by = "item_id") %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager),
              by = "group_id") %>% 
    mutate(is_tva = ifelse(item_id %in% tva_start,
                           1,
                           0))

sku_inventory_start_current_month <- sku_inventory_start_current_month_raw %>% 
    group_by(category_name, category_manager) %>%
    summarise(total_sku = n(),
              tva_sku = sum(is_tva == 1)) %>%
    filter(!is.na(category_name))

active_sku_finish_data <- face_data %>%
    filter(!item_id %in% tva_finish,
           face_qty > 0) %>%
    select(-date)

active_sku_finish_total <- active_sku_finish_data %>%
    group_by(item_id) %>%
    summarise(total_face = sum(face_qty))

sku_inventory_finish_current_month <- inventory_df %>%
    filter(date == date_finish) %>%
    group_by(item_id) %>% 
    summarise(total_item_qty = sum(total_item_qty),
              total_item_sum = sum(total_item_sum)) %>% 
    filter(total_item_qty > 0) %>%
    
    left_join(select(ref_items, item_id, group_id),
              by = "item_id") %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager),
              by = "group_id") %>% 
    mutate(is_tva = ifelse(item_id %in% tva_start,
                           1,
                           0)) %>%

    left_join(active_sku_finish_total, by = "item_id") %>%

    group_by(category_name, category_manager) %>%
    summarise(total_sku = n(),
              activ_sku_bal = sum(!is.na(total_face)),
              tva_sku = sum(is_tva == 1)) %>%
    ungroup() %>%
    filter(!is.na(category_name)) %>%
    left_join(select(sku_inventory_start_current_month, category_name,
                     category_manager, total_sku_start = total_sku,
                     tva_sku_start = tva_sku),
              by = c("category_name", "category_manager")) %>%
    mutate(total_sku_change = ifelse(is.na(total_sku_start),
                                     10,
                                     round((total_sku - total_sku_start)/
                                               total_sku_start, 2)),
           tva_sku_change = ifelse(tva_sku_start == 0,
                                   ifelse(tva_sku == 0,
                                          0,
                                          10),
                                   round((tva_sku - tva_sku_start)/
                                              tva_sku_start, 2)),
           category = paste0(category_name, "/", category_manager)) %>%
    select(category, total_sku, total_sku_change, tva_sku, tva_sku_change,
           activ_sku_bal)

active_sku_start_data <- get_face(date_start + years(2000)) %>%
    filter(!item_id %in% tva_finish,
           face_qty > 0)

active_sku_start_cat <- active_sku_start_data %>%
    distinct(item_id) %>%
    left_join(select(ref_items, item_id, group_id),
              by = "item_id") %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager),
              by = "group_id") %>%
    filter(group_id != "000003589",
           !is.na(category_name)) %>%
    mutate(category = paste0(category_name, "/", category_manager)) %>%
    count(category) %>%
    filter(str_detect(category, "15. Копіцентр", negate = TRUE))

active_sku_finish <- active_sku_finish_data %>%
    count(item_id) %>%
    left_join(select(ref_items, item_id, group_id),
              by = "item_id") %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager),
              by = "group_id") %>%
    filter(group_id != "000003589",
           !is.na(category_name)) %>%
    mutate(category = paste0(category_name, "/", category_manager)) %>%
    count(category, name = "active_sku") %>%
    left_join(active_sku_start_cat, by = "category") %>%
    mutate(active_sku_change = ifelse(is.na(n),
                                     10,
                                     round((active_sku - n)/ n, 2))) %>%
    select(-n)

active_sku_finish_cat <- active_sku_finish_data %>%
    distinct(item_id) %>%
    left_join(select(ref_items, item_id, group_id),
              by = "item_id") %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager),
              by = "group_id") %>%
    filter(group_id != "000003589",
           !is.na(category_name)) %>%
    mutate(category = paste0(category_name, "/", category_manager)) %>%
    count(category, name = "active_sku") %>%
    filter(str_detect(category, "15. Копіцентр", negate = TRUE)) %>%
    left_join(active_sku_start_cat, by = "category") %>%
    mutate(active_sku_change = ifelse(is.na(n),
                                     10,
                                     round((active_sku - n)/ n, 2))) %>%
    select(-n)


sale_sku_current_month <- sale_sku_current_month_raw %>%
    left_join(select(ref_items, item_id, group_id),
              by = "item_id") %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager),
              by = "group_id") %>%
    filter(group_id != "000003589",
           !is.na(category_name)) %>%
    mutate(category = paste0(category_name, "/", category_manager)) %>%
    count(category, name = "sale_sku_qty")

without_sale <- active_sku_finish_data %>%
    distinct(item_id) %>%
    left_join(sale_sku_current_month_raw) %>%
    left_join(select(ref_items, item_id, group_id),
              by = "item_id") %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager),
              by = "group_id") %>%
    filter(group_id != "000003589",
           !is.na(category_name)) %>%
    mutate(category = paste0(category_name, "/", category_manager)) %>%
    group_by(category) %>%
    summarise(sku_without_sale = sum(is.na(total_sale_qty)))

new_sku <- purchases_new_sku_fn(date_start + years(2000),
                                date_finish + years(2000)) %>%
    distinct(item_id) %>%
    left_join(select(ref_items, item_id, group_id),
              by = "item_id") %>%
    left_join(select(ref_item_group, group_id, category_name,
                     category_manager),
              by = "group_id") %>%
    filter(group_id != "000003589",
           !is.na(category_name)) %>%
    mutate(category = paste0(category_name, "/", category_manager)) %>%
    count(category, name = "new_sku_qty")

sku_analysis_data <- sku_inventory_finish_current_month %>%
    select(-activ_sku_bal) %>%
    left_join(active_sku_finish_cat,  by = c("category")) %>%
    left_join(sale_sku_current_month, by = c("category")) %>%
    left_join(without_sale,           by = c("category")) %>%
    left_join(new_sku,                by = c("category")) %>%
    mutate(across(where(is.numeric), ~ifelse(is.na(.), 0, .)),
           sale_sku_share = round(sale_sku_qty / total_sku, 2),
           sku_without_sale_share = ifelse(
               active_sku == 0,
               0,
               round(sku_without_sale / active_sku, 2)
               )
           )%>%
    relocate(tva_sku, tva_sku_change, .after = active_sku_change) %>%
    relocate(sale_sku_share, .after = sale_sku_qty) %>%
    relocate(new_sku_qty, .before = sale_sku_qty) %>%
    filter(str_detect(category, "15. Копіцентр", negate = TRUE))

total_sku <- sum(sku_analysis_data$total_sku)

total_active_sku <- sum(sku_analysis_data$active_sku)

total_tva_sku <- sum(sku_analysis_data$tva_sku)

total_sku_without_sale <- sum(sku_analysis_data$sku_without_sale)

total_sale_sku <- sum(sku_analysis_data$sale_sku_qty)

total_new_sku <- sum(sku_analysis_data$new_sku_qty)

table1 <- sku_analysis_data %>%
    mutate(category = str_replace(category, "[:space:][:alpha:]+$", ""),
           category = str_replace(category,
                                  "Прибирання(.*?)(?=/)", "Прибирання"),
           category = str_replace(category, "Шкільн(і|а|ий)[:space:]", "Шк."),
           category = str_replace(category, "Успішний ", "Усп."),
           category = str_replace(category, "Зручність і лайфстайл",
                                  "Зручність")) %>% 
    reactable(
        bordered = TRUE,
        pagination = FALSE,
        highlight = TRUE,
        striped = TRUE,
        defaultColDef = colDef(headerStyle = list(fontSize = 13)),
        theme = reactableTheme(
            borderColor = "#C8D0D1"),
        columns = list(
            category = colDef(name = "Кат.Напр./Кат.Менеджер",
                              style = cell_style(font_size = 12.5),
                              minWidth = 125),
            total_sku  = colDef(name = "Загальна кіл-ть SKU",
                                align = "left",
                                cell = data_bars(., text_size = 13,
                                                 force_outside = c(0,
                                            max(sku_analysis_data$total_sku)/3),
                                                 box_shadow = TRUE)
                                ),
            total_sku_change = colDef(name = "Зм.",
                                      maxWidth = 50,
                                      format = colFormat(percent = TRUE,
                                                         digits = 0),
                                      style = function(value) {
                                          color <- if (value > 0) {
                                              "#008000"
                                          } else if (value < 0) {
                                              "#e00000"
                                          }
                                          list(color = color, fontSize = 13)
                                      }
            ),
            active_sku = colDef(name = "Основн.асорт.",
                                align = "left",
                                cell = data_bars(., text_size = 13,
                                                 force_outside = c(0,
                                            max(sku_analysis_data$active_sku)/3),
                                                 box_shadow = TRUE)),
            active_sku_change = colDef(name = "Зм.",
                                       maxWidth = 60,
                                       format = colFormat(percent = TRUE,
                                                          digits = 0),
                                       style = function(value) {
                                           color <- if (value > 0) {
                                               "#008000"
                                           } else if (value < 0) {
                                               "#e00000"
                                           }
                                           list(color = color, fontSize = 13)
                                       }
            ),
            tva_sku = colDef(name = "Кіл-ть ТВА",
                             align = "left",
                             cell = data_bars(., text_size = 13,
                                              fill_color = "#FF3B28",
                                              force_outside = c(0,
                                              max(sku_analysis_data$tva_sku)/3),
                                              box_shadow = TRUE)),
            tva_sku_change = colDef(name = "Зм.",
                                    maxWidth = 55,
                                    format = colFormat(percent = TRUE,
                                                       digits = 0),
                                    style = function(value) {
                                        color <- if (value > 0) {
                                            "#e00000"
                                        } else if (value < 0) {
                                            "#008000"
                                        }
                                        list(color = color, fontSize = 13)
                                    }
            ),
            new_sku_qty = colDef(name = "Нові SKU",
                                 align = "left",
                                 cell = data_bars(., text_size = 13,
                                                  force_outside = c(0,
                                          max(sku_analysis_data$new_sku_qty)/3),
                                                  box_shadow = TRUE)),
            sale_sku_qty = colDef(name = "SKU з продажем",
                                  align = "left",
                                  cell = data_bars(., text_size = 13,
                                                 force_outside = c(0,
                                         max(sku_analysis_data$sale_sku_qty)/3),
                                                 box_shadow = TRUE)),
            sale_sku_share = colDef(name = "Частка",
                                    maxWidth = 60,
                                    format = colFormat(percent = TRUE,
                                                       digits = 0),
                                    style = function(value) {
                                        color <- if (value >= 0.75) {
                                            "#008000"
                                        } else if (value < 0.75) {
                                            "#e00000"
                                        }
                                        list(color = color, fontSize = 13)
                                    }
            ),
            sku_without_sale = colDef(name = "Кіл-ть ТБП(осн.асорт.)",
                                      align = "left",
                                      cell = data_bars(., text_size = 13,
                                              fill_color = "#FF3B28",
                                              force_outside = c(0,
                                              max(sku_analysis_data$sku_without_sale)/3),
                                              box_shadow = TRUE)),
            sku_without_sale_share = colDef(name = "Частка",
                                            maxWidth = 60,
                                            format = colFormat(percent = TRUE,
                                                               digits = 0),
                                            style = function(value) {
                                                color <- if (value < 0.3) {
                                                    "#008000"
                                                } else if (value >= 0.3) {
                                                    "#e00000"
                                                }
                                                list(color = color, fontSize = 13)
                                            }
            )
        )
    )


subdiv_sku_start <- inventory_df %>%
    filter(date == date_start) %>%
    left_join(select(ref_items, item_id, group_id),
                  by = "item_id") %>% 
    left_join(select(ref_item_group, group_id, category_name,category_manager),
              by = "group_id") %>%
    group_by(store_id, category_name, category_manager) %>% 
    summarise(total_sku = length(unique(item_id))) %>% 
    ungroup() %>% 
    group_by(store_id) %>%
    summarise(total_sku_start = sum(total_sku))

active_subdiv_sku <- active_sku_finish_data %>%
    count(store_id, name = "active_sku")

sale_subdiv_sku <- sale_current_month %>%
    group_by(store_id, item_id) %>%
    summarise(total_item_sale_qty = sum(item_qty)) %>%
    ungroup() %>%
    filter(total_item_sale_qty > 0) %>%
    left_join(active_sku_finish_data, by = c("store_id", "item_id")) %>%
    mutate(is_tva = ifelse(item_id %in% tva_finish,
                           1,
                           0)) %>%
    group_by(store_id) %>%
    summarise(total_sale_sku = n(),
              sale_active_sku = sum(!is.na(face_qty)),
              sale_tva_sku = sum(is_tva == 1),
              avr_sale_qty = median(total_item_sale_qty))


subdiv_sku_analysis_finish <- inventory_df %>%
    filter(date == date_finish) %>%
    group_by(store_id, item_id) %>%
    summarise(total_item_qty = sum(total_item_qty)) %>%
    ungroup()

current_month_store_motion <- stock_motion_data(date_start  + years(2000),
                                               date_finish + years(2000)) %>% 
    mutate(item_motion_qty = ifelse(type_motion == 1,
                             -item_motion_qty,
                             item_motion_qty)) %>% 
    group_by(store_id, item_id) %>% 
    summarise(subdiv_movement = sum(item_motion_qty))

subdiv_sku_analysis_start <- inventory_df %>%
    filter(date == date_finish) %>%
    group_by(store_id, item_id) %>%
    summarise(total_item_qty_start = sum(total_item_qty)) %>%
    ungroup()

without_residue <- active_sku_finish_data %>% 
    mutate(is_tva = ifelse(item_id %in% tva_finish,
                           1,
                           0)) %>%
    left_join(subdiv_sku_analysis_finish, by = c("store_id", "item_id")) %>% 
    left_join(subdiv_sku_analysis_start,  by = c("store_id", "item_id")) %>% 
    left_join(current_month_store_motion, by = c("store_id", "item_id")) %>%
    group_by(store_id) %>% 
    summarise(without_residue_sku = sum(is_tva == 0 & is.na(total_item_qty) &
                                           is.na(total_item_qty_start) &
                                           is.na(subdiv_movement)))
    
subdiv_sku_analysis <- subdiv_sku_analysis_finish %>%
    left_join(active_sku_finish_data, by = c("store_id", "item_id")) %>%
    mutate(is_tva = ifelse(item_id %in% tva_finish,
                           1,
                           0)) %>% 
    group_by(store_id) %>%
    summarise(total_sku = sum(total_item_qty > 0),
              active_sku_balance = sum(total_item_qty > 0 & !is.na(face_qty)),
              tva_sku = sum(total_item_qty > 0 & is_tva == 1)) %>%
    left_join(subdiv_sku_start, by = c("store_id")) %>%
    left_join(select(ref_store, store_id, parent_store, subdiv_name, store_name,
                     subdiv_marked),
              by = "store_id") %>%
    filter(parent_store == "Товар",
           !subdiv_name %in% c('Администрация', 'Подарунки ХМ СМ',
                               'Старокостянтинів Підрозділ " ОЦе кава" Планета',
                               'Заправка картріджів'),
           subdiv_marked == FALSE,
           !store_id %in% c("000001064", "000001098")) %>%
    mutate(total_sku_change = round((total_sku - total_sku_start) /
                                        total_sku_start, 2)) %>%
    left_join(active_subdiv_sku, by = "store_id") %>%
    left_join(sale_subdiv_sku,   by = "store_id") %>% 
    left_join(without_residue,   by = "store_id")

subdiv_category <- ref_shops %>%
    select(subdiv_name, subdiv_category = parent_shop) %>%
    distinct()

shop_area <- get_shop_area() %>%
    filter(type_area == "trade_area") %>%
    select(subdiv_name, trade_area = area_value)

# table2 <- subdiv_sku_analysis %>%
#     left_join(subdiv_category, by = "subdiv_name") %>%
#     mutate(subdiv_category = case_when(
#         store_id %in% c("000000001", "000001073") ~ "РЦ",
#         TRUE                                      ~ subdiv_category
#     )) %>%
#     left_join(shop_area, by = "subdiv_name") %>%
#     select(store_name, subdiv_category, trade_area, total_sku, total_sku_change,
#            active_sku_balance, tva_sku, active_sku, total_sale_sku,
#            sale_active_sku, sale_tva_sku) %>%
#     mutate(active_sku_balance_share = round(active_sku_balance / total_sku, 2),
#            .after = active_sku_balance) %>%
#     mutate(tva_sku_share = round(tva_sku / total_sku, 2),
#            .after = tva_sku) %>%
#     mutate(active_sku_service = round(active_sku_balance / active_sku, 2),
#            .after = active_sku) %>%
#     reactable(
#         bordered = TRUE,
#         pagination = FALSE,
#         highlight = TRUE,
#         striped = TRUE,
#         defaultColDef = colDef(headerStyle = list(fontSize = 13),
#                                style = cell_style(font_size = 10)),
#         theme = reactableTheme(
#             borderColor = "#C8D0D1"),
#         groupBy = c("subdiv_category"),
#         columns = list(
#             subdiv_category = colDef(name = "Група",
#                                      minWidth = 110),
#             store_name = colDef(name = "Підрозділ",
#                                 minWidth = 120,
#                                 style = cell_style(font_size = 12)),
#             trade_area = colDef(name = "Торг.пл.",
#                                 aggregate = "sum",
#                                 style = cell_style(font_size = 12),
#                                 format = colFormat(separators = TRUE,
#                                                    digits = 0),
#                                 maxWidth = 70),
#             total_sku  = colDef(name = "Усього на залишку",
#                                 aggregate = "median",
#                                 align = "left",
#                                 cell = data_bars(., text_size = 13,
#                                                  force_outside = c(0,
#                                        max(subdiv_sku_analysis$total_sku)/3),
#                                                  box_shadow = TRUE)),
#             total_sku_change = colDef(name = "Зм.",
#                                       maxWidth = 50,
#                                       format = colFormat(percent = TRUE,
#                                                          digits = 0),
#                                       style = function(value) {
#                                           color <- if (value > 0) {
#                                               "#008000"
#                                           } else if (value < 0) {
#                                               "#e00000"
#                                           }
#                                           list(color = color, fontSize = 13)
#                                       }
#             ),
#             active_sku_balance = colDef(name = "Осн.асорт. на залишку",
#                                         aggregate = "median",
#                                         align = "left",
#                                         cell = data_bars(., text_size = 13,
#                                                          force_outside = c(0,
#                                 max(subdiv_sku_analysis$active_sku_balance)/3),
#                                                          box_shadow = TRUE)),
#             active_sku_balance_share = colDef(name = "Частка",
#                                               maxWidth = 60,
#                                        format = colFormat(percent = TRUE,
#                                                           digits = 0),
#                                        style = function(value) {
#                                            color <- if (value >= 0.8) {
#                                                "#008000"
#                                            } else if (value < 0.8) {
#                                                "#e00000"
#                                            }
#                                            list(color = color, fontSize = 13)
#                                        }
#             ),
#             tva_sku = colDef(name = "ТВА на залишку",
#                              aggregate = "median",
#                              align = "left",
#                              cell = data_bars(., text_size = 13,
#                                               fill_color = "#FF3B28",
#                                               force_outside = c(0,
#                                             max(subdiv_sku_analysis$tva_sku)/3),
#                                               box_shadow = TRUE)),
#             tva_sku_share = colDef(name = "Частка",
#                                    maxWidth = 60,
#                                    format = colFormat(percent = TRUE,
#                                                        digits = 0),
#                                     style = function(value) {
#                                         color <- if (value >= 0.15) {
#                                             "#e00000"
#                                         } else if (value < 0.15) {
#                                             "#008000"
#                                         }
#                                         list(fontSize = 13, color = color)
#                                     }
#             ),
#             active_sku = colDef(name = "Прописано осн.асорт.",
#                                 aggregate = "median",
#                                 align = "left",
#                                 cell = data_bars(., text_size = 13,
#                                                  force_outside = c(0,
#                                        max(subdiv_sku_analysis$active_sku)/3),
#                                                  box_shadow = TRUE)),
#             active_sku_service = colDef(name = "Рів.серв.",
#                                         aggregate = "median",
#                                         maxWidth = 75,
#                                         format = colFormat(percent = TRUE,
#                                                            digits = 0),
#                                         style = function(value) {
#                                             color <- if (value >= 0.8) {
#                                                 "#008000"
#                                             } else if (value < 0.8) {
#                                                 "#e00000"
#                                             }
#                                             list(fontSize = 13, color = color)
#                                         }),
#             total_sale_sku = colDef(name = "Усього продавалось",
#                                     aggregate = "median",
#                                     align = "left",
#                                     cell = data_bars(., text_size = 13,
#                                                      force_outside = c(0,
#                                     max(subdiv_sku_analysis$total_sale_sku)/3),
#                                                      box_shadow = TRUE)
#                                    ),
#             sale_active_sku = colDef(name = "Осн.асорт.продавалось",
#                                      aggregate = "median",
#                                      align = "left",
#                                      cell = data_bars(., text_size = 13,
#                                                       force_outside = c(0,
#                                      max(subdiv_sku_analysis$sale_active_sku)/3),
#                                                       box_shadow = TRUE)),
#             sale_tva_sku = colDef(name = "ТВА продавалось",
#                                   aggregate = "median",
#                                   align = "left",
#                                   cell = data_bars(., text_size = 13,
#                                                    force_outside = c(0,
#                                        max(subdiv_sku_analysis$sale_tva_sku)/3),
#                                                    box_shadow = TRUE))
#         )
#     )

fig_subdiv_sku_analysis_data <- subdiv_sku_analysis %>%
    filter(!store_id %in% c("000000001", "000001073", "000001113")) %>%   # "РЦ"
    select(store_name, total_sku, active_sku = active_sku_balance, tva_sku) %>%
    mutate(other_sku = total_sku - active_sku - tva_sku,
           active_prop = round(active_sku / total_sku, 2),
           tva_prop = round(tva_sku / total_sku, 2),
           other_prop = round(other_sku / total_sku, 2)) %>% 
    select(-total_sku) %>%  
    pivot_longer(-store_name,
                 names_sep = "_",
                 names_to = c("type", ".value")) %>%
    mutate(lbl = format(sku, big.mark = "'"),
           type = fct_recode(type,
                             "Осн.асорт." = "active",
                             "ТВА" = "tva",
                             "Інші" = "other"),
           type = fct_relevel(type,
                              "ТВА",
                              "Інші",
                              "Осн.асорт.")) %>% 
    left_join(select(ref_store, subdiv_name, store_name),
              by = "store_name") %>% 
    left_join(shop_area, by = "subdiv_name")

fig_subdiv_sku_analysis <- fig_subdiv_sku_analysis_data %>% 
    ggplot(aes(x = reorder(paste0(store_name, " (", trade_area, "м2)"), trade_area),
               y = prop,
               fill = type)) +
    geom_bar(stat = "identity",
             position = "fill") +
    scale_y_continuous(breaks = seq(0, 1, .2),
                       label = scales::percent) +
    geom_text(#data = filter(fig_subdiv_sku_analysis_data, type != "Інші"),
              aes(label = lbl),
              size = 2.2,
              position = position_stack(vjust = 0.5)) +
    scale_fill_manual(values = c("orangered",
                                 "orange",
                                 "darkseagreen")) +
    coord_flip() +
    labs(y = "Частка у залишках",
         fill = "",
         x = "",
         title = "") +
    theme_minimal() +
    theme(legend.text = element_text(size = 9),
          axis.text.x = element_text(size = 8),
          axis.text.y = element_text(size = 8),
          legend.position = "top",
          legend.text.align = 0.1,
          legend.spacing.x = unit(0.45, 'cm'))


fig_main_range <- subdiv_sku_analysis %>%
    filter(!store_id %in% c("000000001", "000001073", "000001113")) %>%   # "РЦ"
    select(store_name, active_sku, sale_sku = sale_active_sku,
           withoutResidue_sku = without_residue_sku) %>%
    mutate(withoutSale_sku = active_sku - sale_sku - withoutResidue_sku,
           sale_prop = round(sale_sku / active_sku, 2),
           withoutResidue_prop = round(withoutResidue_sku / active_sku, 2),
           withoutSale_prop = round(withoutSale_sku / active_sku, 2)) %>% 
    select(-active_sku) %>%  
    pivot_longer(-store_name,
                 names_sep = "_",
                 names_to = c("type", ".value")) %>%
    mutate(lbl = format(sku, big.mark = "'"),
           type = fct_recode(type,
                             "Продавалися" = "sale",
                             "Без залишків" = "withoutResidue",
                             "Без продажу" = "withoutSale"),
           type = fct_relevel(type,
                              "Без продажу",
                              "Без залишків",
                              "Продавалися")) %>% 
    left_join(select(ref_store, subdiv_name, store_name),
              by = "store_name") %>% 
    left_join(shop_area, by = "subdiv_name") %>% 
    ggplot(aes(x = reorder(store_name, trade_area),
               y = prop,
               fill = type)) +
    geom_bar(stat = "identity",
             position = "fill") +
    scale_y_continuous(breaks = seq(0, 1, .2),
                       label = scales::percent) +
    geom_text(#data = filter(category_structure_plot_data, prop > 0.03),
        aes(label = lbl),
        size = 2.2,
        position = position_stack(vjust = 0.5)) +
    scale_fill_manual(values = c("orangered",
                                 "orange",
                                 "darkseagreen")) +
    coord_flip() +
    labs(y = "Частка у загальній кількості осн.асорт.",
         fill = "",
         x = "",
         title = "") +
    theme_minimal() +
    theme(legend.text = element_text(size = 9),
          axis.text.x = element_text(size = 8),
          axis.text.y = element_text(size = 8),
          legend.position = "top",
          legend.text.align = 0.5,
          legend.spacing.x = unit(0.9, 'cm'))

pareto_data <- sale_current_month %>%
    group_by(item_id) %>%
    summarise(total_sum = sum(sale_sum)) %>%
    filter(total_sum > 0) %>%
    arrange(-total_sum) %>%
    mutate(prop = total_sum / sum(total_sum),
           cum_prop = cumsum(prop),
           number_prop = row_number() / nrow(.)) %>%
    left_join(select(ref_items, item_id, item_name),
              by = "item_id") %>%
    select(item_name, cum_prop, number_prop)

fig11 <- pareto_data %>%
    ggplot(aes(x = number_prop, y = cum_prop)) +
    geom_point(color = "steelblue") +
    geom_line(color = "steelblue") +
    scale_x_continuous(label = scales::percent, n.breaks = 6) +
    scale_y_continuous(label = scales::percent, n.breaks = 6) +
    theme_light() +
    labs(x = "Частка у кількості SKU", y = "Частка у продажах")


category_structure_plot_data <- sku_inventory_finish_current_month %>%
    filter(str_detect(category, "15. Копіцентр", negate = TRUE)) %>%
    mutate(active_prop = round(activ_sku_bal / total_sku, 2),
           tva_prop = round(tva_sku / total_sku, 2),
           other_prop = round((total_sku - activ_sku_bal - tva_sku) /
                                  total_sku, 2)) %>%
    select(category, active_prop:other_prop) %>%
    pivot_longer(cols = 2:4,
                 names_to = "type",
                 values_to = "prop") %>%
    mutate(lbl = scales::percent(prop, accuracy = 1),
           type = fct_recode(type,
                             "Осн.асорт." = "active_prop",
                             "ТВА" = "tva_prop",
                             "Інші" = "other_prop"),
           type = fct_relevel(type,
                              "ТВА",
                              "Інші",
                              "Осн.асорт."))

fig12 <- category_structure_plot_data %>%
    ggplot(aes(x = as.factor(category),
               y = prop,
               fill = as.factor(type))) +
    geom_bar(stat = "identity",
             position = "fill") +
    scale_y_continuous(breaks = seq(0, 1, .2),
                       label = scales::percent) +
    geom_text(data = filter(category_structure_plot_data, prop > 0.03),
              aes(label = lbl),
              size = 2.5,
              position = position_stack(vjust = 0.5)) +
    scale_fill_manual(values = c("orangered",
                                 "orange",
                                 "darkseagreen")) +
    coord_flip() +
    labs(y = "Частка",
         fill = "",
         x = "",
         title = "") +
    theme_minimal() +
    theme(legend.text = element_text(size = 8),
          axis.text.x = element_text(size = 8),
          axis.text.y = element_text(size = 8),
          legend.position = "top",
          legend.text.align = 0.1,
          legend.spacing.x = unit(0.3, 'cm'))

rm(sku_inventory_start_current_month_raw,
   sku_inventory_start_current_month, active_sku_finish_data,
   active_sku_finish_total, sku_inventory_finish_current_month,
   active_sku_start_data, active_sku_start_cat, active_sku_finish,
   active_sku_finish_cat, sale_sku_current_month, without_sale, new_sku,
   sku_analysis_data, subdiv_sku_start, active_subdiv_sku, sale_subdiv_sku,
   subdiv_sku_analysis, pareto_data, category_structure_plot_data,
   current_month_store_motion, subdiv_sku_analysis_finish,
   subdiv_sku_analysis_start)
```

```{r suppliers_data}
purchases_raw <- purchases_data(date_start_year + years(2000),
                                date_finish + years(2000)) %>%
    filter(str_detect(contract_name, "^685", negate = TRUE))

purchases_item_data <- purchases_raw %>%
    mutate(month = month(date, label = TRUE)) %>%
    group_by(month, supplier_id, item_id) %>%
    summarise(item_total_sum = sum(item_sum) + sum(item_vat),
              item_total_qty = sum(item_qty)) %>%
    ungroup()

suppliers_purchase_data <- purchases_item_data %>%
    group_by(month, supplier_id) %>%
    summarise(total_sum = sum(item_total_sum),
              total_qty = sum(item_total_qty),
              total_sku = sum(item_total_qty > 0)) %>%
    ungroup()

suppliers_by_month <- suppliers_purchase_data %>%
    group_by(month) %>%
    summarise(suppl_qty = sum(total_qty > 0))

current_month_suppl_qty <- suppliers_by_month$suppl_qty[
    suppliers_by_month$month == month(date_start, label = TRUE)]

fig13 <- suppliers_by_month %>%
    mutate(label_text = str_glue("Місяць: {month}
                                  Кількість: {suppl_qty}")) %>% 
    ggplot(aes(x = month, y = suppl_qty, group = 1)) +
    geom_line(size = 1, color = "steelblue") +
    geom_point(aes(text = label_text), shape = 21, size = 3, fill = "steelblue") +
    # scale_x_date(date_breaks = '2 months', 
    #              date_labels = "%b-%y") +
    theme_minimal() +
    labs(y = "",
         x = "",
         title = "")

top_suppliers <- suppliers_purchase_data %>%
    filter(month == reporting_month) %>%
    slice_max(total_sum, n = 5) %>%
    left_join(select(ref_suppliers, supplier_id, supplier_name),
              by = "supplier_id") %>%
    mutate(total_sum = round(total_sum / 1000, 1))

fig17 <- top_suppliers %>%
    ggplot(aes(x = reorder(supplier_name, total_sum), y = total_sum)) +
    geom_bar(stat = "identity", fill = "lightblue") +
    geom_text(
        aes(label = total_sum),
        size = 4.5,
        hjust = 1, position = position_dodge(.9)
    ) +
    coord_flip() +
    theme_minimal() +
    labs(x = "", y = "") +
    theme(axis.text.y = element_text(size = 11),
          axis.text.x = element_blank(),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank())


suppliers_data <- tibble(date = seq.Date(date_start_year,
                                         date_finish,
                                         by = "month")) %>%
    mutate(debt_data = map(date + years(2000), partner_debt_data)) %>% 
    unnest(cols = debt_data) %>%
    left_join(select(ref_contract, contract_id, contract_name,
                         type_order)) %>% 
    left_join(select(ref_suppliers, supplier_id, supplier_parent_id,
                     main_cust_id),
              by = c("partner_id" = "supplier_id")) %>% 
    filter(type_order == 0,
           !str_detect(contract_name, "6851"),
           !supplier_parent_id %in% "000423140")

debt_month_total <- suppliers_data %>%
    group_by(date) %>%
    summarise(month_debt_sum = round(-sum(balance) / 1000, 1))

current_month_debt <- debt_month_total$month_debt_sum[
    debt_month_total$date == date_finish]

fig15 <- debt_month_total %>%
    mutate(label_text = str_glue("Дата: {date}
                                  Сума: {month_debt_sum}")) %>% 
    ggplot(aes(x = date, y = month_debt_sum, group = 1)) +
    geom_line(linewidth = 1, color = "steelblue") +
    geom_point(aes(text = label_text), shape = 21, size = 3, fill = "steelblue") +
    theme_minimal() +
    labs(y = "",
         x = "",
         title = "")

debt_suppliers_data <- suppliers_data %>%
    filter(date == date_finish) %>%
    mutate(partner_id = ifelse(is.na(main_cust_id),
                               partner_id,
                               main_cust_id)) %>% 
    group_by(partner_id) %>%
    summarise(supplier_sum = round(-sum(balance) / 1000, 1))

top_debt_suppliers <- debt_suppliers_data %>%
    slice_max(supplier_sum, n = 5) %>%
    rename(supplier_id = partner_id) %>% 
    left_join(select(ref_suppliers, supplier_id, supplier_name),
              by = "supplier_id")

fig19 <- top_debt_suppliers %>%
    ggplot(aes(x = reorder(supplier_name, supplier_sum), y = supplier_sum)) +
    geom_bar(stat = "identity", fill = "lightblue") +
    geom_text(
        aes(label = supplier_sum),
        size = 4.5,
        hjust = 1, position = position_dodge(.9)
    ) +
    coord_flip() +
    theme_minimal() +
    labs(x = "", y = "") +
    theme(axis.text.y = element_text(size = 11),
          axis.text.x = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_blank())


redeemed_goods_total <- inventory_df %>%
    filter(date >= date_start_year) %>% 
    group_by(date, item_id) %>% 
    summarise(total_item_qty = sum(total_item_qty),
              total_item_sum = sum(total_item_sum)) %>% 
    filter(total_item_qty > 0) %>% 
    left_join(select(ref_items, item_id, supplier_id = partner_id),
              by = "item_id") %>% 
    group_by(date, supplier_id) %>% 
    summarise(supplier_total_sum = sum(total_item_sum)) %>% 
                      
    group_by(date) %>%
    summarise(month_inventory_sum = round(sum(supplier_total_sum) / 1000, 1)) %>%
    left_join(debt_month_total, by = "date") %>%
    mutate(redeemed_goods_sum = month_inventory_sum - month_debt_sum) %>%
    select(date, redeemed_goods_sum)

redeemed_goods_current_month <- redeemed_goods_total$redeemed_goods_sum[
    redeemed_goods_total$date == date_finish]

fig16 <- redeemed_goods_total %>%
    mutate(label_text = str_glue("Дата: {date}
                                  Сума: {redeemed_goods_sum}")) %>%
    ggplot(aes(x = date, y = redeemed_goods_sum, group = 1)) +
    geom_line(linewidth = 1, color = "steelblue") +
    geom_point(aes(text = label_text), shape = 21, size = 3, fill = "steelblue") +
    theme_minimal() +
    labs(y = "",
         x = "",
         title = "")

redeemed_goods_suppl_previos <- inventory_df %>%
    filter(date == (date_finish - months(1))) %>%
    group_by(item_id) %>% 
    summarise(total_item_qty = sum(total_item_qty),
              total_item_sum = sum(total_item_sum)) %>% 
    filter(total_item_qty > 0) %>% 
    left_join(select(ref_items, item_id, supplier_id = partner_id),
              by = "item_id") %>% 
    group_by(supplier_id) %>% 
    summarise(supplier_total_sum = round(sum(total_item_sum) / 1000, 1)) %>%
    ungroup() %>% 
    
    full_join(suppliers_data %>%
                  filter(date == (date_finish - months(1))) %>%
                  mutate(partner_id = ifelse(is.na(main_cust_id),
                                             partner_id,
                                             main_cust_id)) %>% 
                  group_by(partner_id) %>%
                  summarise(supplier_sum = round(-sum(balance) / 1000, 1)),
              by = c("supplier_id" = "partner_id")) %>%
    mutate(across(where(is.numeric), ~ifelse(is.na(.), 0, .)),
           sup_redeemed_goods_sum_prev = supplier_total_sum - supplier_sum) %>% 
    select(supplier_id, sup_redeemed_goods_sum_prev)

top_redeemed_goods_suppl <- inventory_df %>%
    filter(date == date_finish) %>%
    group_by(date, item_id) %>% 
    summarise(total_item_qty = sum(total_item_qty),
              total_item_sum = sum(total_item_sum)) %>% 
    filter(total_item_qty > 0) %>% 
    left_join(select(ref_items, item_id, supplier_id = partner_id),
              by = "item_id") %>% 
    group_by(date, supplier_id) %>% 
    summarise(supplier_total_sum = sum(total_item_sum)) %>%
    ungroup() %>% 
    
    full_join(debt_suppliers_data,
              by = c("supplier_id" = "partner_id")) %>%
    mutate(across(where(is.numeric), ~ifelse(is.na(.), 0, .)),
           sup_redeemed_goods_sum = round(supplier_total_sum / 1000 -
                                              supplier_sum, 1)) %>%
    slice_max(sup_redeemed_goods_sum, n = 5) %>%
    left_join(select(ref_suppliers, supplier_id, supplier_name),
              by = "supplier_id") %>% 
    left_join(redeemed_goods_suppl_previos, by = "supplier_id") %>% 
    replace_na(list(sup_redeemed_goods_sum_prev = 0)) %>% 
    mutate(change = sup_redeemed_goods_sum - sup_redeemed_goods_sum_prev,
           sign = case_when(
               change  > 0 ~ "+",
               change  < 0 ~ "-",
               change == 0 ~ ""),
           label = str_c(sup_redeemed_goods_sum, "\n(", sign, round(abs(change),1),
                         ")"))

fig20 <- top_redeemed_goods_suppl %>%
    ggplot(aes(x = reorder(supplier_name, sup_redeemed_goods_sum),
               y = sup_redeemed_goods_sum)) +
    geom_bar(stat = "identity", fill = "lightblue") +
    geom_text(
        aes(label = label),
        size = 4.5,
        hjust = 1, position = position_dodge(.9)
    ) +
    coord_flip() +
    theme_minimal() +
    labs(x = "", y = "") +
    theme(axis.text.y = element_text(size = 11),
          axis.text.x = element_blank(),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank())


lead_time_data <- purchases_raw %>%
    filter(!is.na(order_date)) %>%
    group_by(order_nmbr, doc_purch_nmbr) %>%
    summarise(date = first(date),
              order_date = first(order_date),
              order_sum = sum(item_sum) + sum(item_vat),
              supplier_id = first(supplier_id)) %>%
    mutate(lead_time = as.integer(as.Date(date) - as.Date(order_date)),
           month = month(date, label = TRUE)) %>%
    ungroup()

lead_time_total <- lead_time_data %>%
    group_by(month) %>%
    mutate(wt = order_sum / sum(order_sum)) %>%
    summarise(avr_lead_time = round(weighted.mean(x = lead_time,
                                                  w = wt,
                                                  na.rm = TRUE),
                                    1))

current_month_lead_time <- lead_time_total$avr_lead_time[
    lead_time_total$month == month(date_start, label = TRUE)]

fig14 <- lead_time_total %>%
    mutate(label_text = str_glue("Місяць: {month}
                                  Днів: {avr_lead_time}")) %>%
    ggplot(aes(x = month, y = avr_lead_time, group = 1)) +
    geom_line(size = 1, color = "steelblue") +
    geom_point(aes(text = label_text), shape = 21, size = 3, fill = "steelblue") +
    theme_minimal() +
    labs(y = "",
         x = "",
         title = "")

top_suppliers_lead_time <- lead_time_data %>%
    filter(month == reporting_month) %>%
    mutate(wt = order_sum / sum(order_sum)) %>%
    group_by(supplier_id) %>%
    summarise(avr_lead_time = round(weighted.mean(x = lead_time,
                                                  w = wt,
                                                  na.rm = TRUE))) %>%
    slice_max(avr_lead_time, n = 5) %>%
    left_join(select(ref_suppliers, supplier_id, supplier_name),
              by = "supplier_id")

fig18 <- top_suppliers_lead_time %>%
    ggplot(aes(x = reorder(supplier_name, avr_lead_time), y = avr_lead_time)) +
    geom_bar(stat = "identity", fill = "lightblue") +
    geom_text(
        aes(label = avr_lead_time),
        size = 4.5,
        hjust = 1, position = position_dodge(.9)
    ) +
    coord_flip() +
    theme_minimal() +
    labs(x = "", y = "") +
    theme(axis.text.y = element_text(size = 11),
          axis.text.x = element_blank(),
          panel.grid.major.x = element_blank(),
          panel.grid.major.y = element_blank())


otif_data <- tibble(
    start_month = seq.Date(date_start_year,
                           date_finish - months(1),
                           by = "month"),
    end_month = seq.Date(date_start_year + months(1),
                           date_finish,
                           by = "month")) %>%
    mutate(data = map2(start_month,
                       end_month,
                       otif_fn))

month_otif_df <- otif_data %>%
    mutate(month = month(start_month, label = TRUE),
           on_time = map_dbl(data, function(x) x[[1]]),
           in_full = map_dbl(data, function(x) x[[2]])) %>%
    select(month, on_time, in_full)

current_month_on_time <- month_otif_df$on_time[nrow(month_otif_df)]

fig21 <- month_otif_df %>%
    mutate(label_text = str_glue("Місяць: {month}
                                  Частка: {on_time}")) %>%
    ggplot(aes(x = month, y = on_time, group = 1)) +
    geom_line(size = 1, color = "steelblue") +
    geom_point(aes(text = label_text), shape = 21, size = 3, fill = "steelblue") +
    scale_y_continuous(label = scales::percent) +
    theme_minimal() +
    labs(y = "",
         x = "",
         title = "")

current_month_in_full <- month_otif_df$in_full[nrow(month_otif_df)]

fig22 <- month_otif_df %>%
    mutate(label_text = str_glue("Місяць: {month}
                                  Частка: {in_full}")) %>%
    ggplot(aes(x = month, y = in_full, group = 1)) +
    geom_line(size = 1, color = "steelblue") +
    geom_point(aes(text = label_text), shape = 21, size = 3, fill = "steelblue") +
    scale_y_continuous(label = scales::percent) +
    theme_minimal() +
    labs(y = "",
         x = "",
         title = "")

suppliers_on_time <- otif_data$data[[nrow(otif_data)]][[4]] %>%
    filter(total_qty > 1000) %>%
    left_join(select(ref_suppliers, supplier_id, supplier_name),
              by = "supplier_id") %>%
    arrange(desc(total_qty)) %>%
    slice_min(on_time, n = 5)

fig23 <- suppliers_on_time %>%
    ggplot(aes(x = reorder(supplier_name, on_time),
               y = on_time)) +
    geom_bar(stat = "identity", fill = "lightblue") +
    scale_y_continuous(label = scales::percent,
                       breaks = seq(0, 0.5, .1)) +
    geom_text(
        aes(label = paste0(scales::percent(on_time),"(", total_qty, ")")),
        size = 4,
        hjust = 1, position = position_dodge(.9)
    ) +
    coord_flip() +
    theme_minimal() +
    labs(x = "", y = "") +
    theme(axis.text.y = element_text(size = 11),
          axis.text.x = element_blank(),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank())

suppliers_in_full <- otif_data$data[[nrow(otif_data)]][[3]] %>%
    filter(suppl_orders_qty > 1000) %>%
    left_join(select(ref_suppliers, supplier_id, supplier_name),
              by = "supplier_id") %>%
    arrange(desc(suppl_orders_qty)) %>%
    slice_min(in_full, n = 3)
 
fig24 <- suppliers_in_full %>%
    ggplot(aes(x = reorder(supplier_name, in_full),
               y = in_full)) +
    geom_bar(stat = "identity", fill = "lightblue") +
    scale_y_continuous(label = scales::percent,
                       breaks = seq(0, 0.5, .1)) +
    geom_text(
        aes(label = paste0(scales::percent(in_full),"(", suppl_orders_qty, ")")),
        size = 4,
        hjust = 1, position = position_dodge(.9)
    ) +
    coord_flip() +
    theme_minimal() +
    labs(x = "", y = "") +
    theme(axis.text.x = element_blank(),
          axis.text.y = element_text(size = 11),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_blank())



dbDisconnect(con)

rm(purchases_raw, purchases_item_data, suppliers_purchase_data,
   suppliers_by_month, top_suppliers, lead_time_data, lead_time_total,
   top_suppliers_lead_time, suppliers_data, debt_month_total,
   debt_suppliers_data, top_debt_suppliers, redeemed_goods_total,
   top_redeemed_goods_suppl, otif_data)
```


Основні показники {data-icon="fa-bullseye"}
=======================================================================

Row {data-height=100}
-----------------------------------------------------
### Загальний GMROI за звітний місяць

```{r}
valueBox(
  value = gmroi_current_month,
  icon  = "fa-warehouse",
  color = case_when(
                    gmroi_current_month <  0.3 ~ "danger",
                    gmroi_current_month <  0.4 ~ "warning",
                    gmroi_current_month >= 0.4 ~ "success"
                    )
)
```

### Період обороту запасів за звітний місяць

```{r}
valueBox(
  value = inventory_turnover_current_month,
  icon  = "fa-stopwatch",
  color = case_when(
                    inventory_turnover_current_month > 100 ~ "danger",
                    inventory_turnover_current_month >  90 ~ "warning",
                    inventory_turnover_current_month <= 90 ~ "success"
                    )
)
```


Row {data-height=150}
-----------------------------------------------------
### Загальний GMROI за місяць за останні 12 місяців

```{r}
ggplotly(fig1, tooltip = "text") %>% 
    config(displayModeBar = FALSE)
```

### Період обороту запасів за останні 12 місяців

```{r}
ggplotly(fig4, tooltip = "text") %>% 
    config(displayModeBar = FALSE)
```


Row {data-height=250}
-----------------------------------------------------
### GMROI (12 місяів) по КН/КМ

```{r}
fig2
```

### Період обороту запасів (12 місяів) по КН/КМ

```{r}
fig5
```


Row {data-height=350}
-----------------------------------------------------
### GMROI за подрозділами за звітний місяць {.no-padding}

```{r}
gmroi_subdiv_plot <- gmroi_subdiv_df %>% 
    ggplot(aes(x = reorder(store_subdiv, gmroi),
           y = gmroi, fill = shop_cat, text = gmroi)) +
    geom_bar(stat="identity", alpha = 0.7) +
    scale_fill_viridis_d() +
    labs(x = "", y = "", fill = "Категорія") +
    coord_flip()+
    theme_minimal() +
    theme(axis.text.x = element_text(size = 8),
          axis.text.y = element_text(size = 8),
          legend.text = element_text(size = 7),
          legend.position = c(0.85, 0.25),
          panel.grid.major.y = element_blank())

plotly::ggplotly(gmroi_subdiv_plot, tooltip = "text")
```

### Період обороту запасів за подрозділами за звітний місяць {.no-padding}

```{r}
turnover_subdiv_plot <- turnover_subdiv_df %>% 
    ggplot(aes(x = reorder(store_subdiv, desc(turnover)),
               y = turnover, fill = shop_cat, text = turnover)) +
    geom_bar(stat="identity", alpha = 0.7) +
    scale_fill_viridis_d() +
    labs(x = "", y = "", fill = "Категорія") +
    coord_flip()+
    theme_minimal() +
    theme(axis.text.x = element_text(size = 8),
          axis.text.y = element_text(size = 8),
          legend.text = element_text(size = 7),
          legend.position = c(0.85, 0.75),
          panel.grid.major.y = element_blank(),
          panel.grid.major.x = element_line(colour = "darkgrey"))

plotly::ggplotly(turnover_subdiv_plot, tooltip = "text")
```


Row {data-height=400}
-----------------------------------------------------
### GMROI за подрозділами та кат.напр./кат.мен. за звітний місяць {.no-padding}

```{r}
fig3
```

### GMROI за номенклатурними групами (3-й рівень шєрархії) {.no-padding}

```{r}
plotly::ggplotly(fig6, tooltip = "text")
```


Аналіз планограм {data-icon="fa-chart-bar"}
=======================================================================
Row {data-height=100}
-----------------------------------------------------
### Загальна сума поличного простору активних стелажів (м^3^)

```{r}
valueBox(
  value = paste0(total_shelf_space, "м3"),
  color = "info"
)
```

### Загальна сума поличного простору, прописаного у планограмах (м^3^)

```{r}
valueBox(
  value = paste0(total_active_shelf_space, "м3"),
  color = case_when(
             total_active_shelf_space / total_shelf_space  < 0.8 ~ "danger",
             total_active_shelf_space / total_shelf_space  < 0.95 ~ "warning",
             total_active_shelf_space / total_shelf_space >= 0.95 ~ "success"
                    )
)
```

Row {data-height=500}
-----------------------------------------------------
### Індекс справедливої частки категорії

```{r}
fig7
```

### Частка кат.напр./кат.мен. у поличному просторі підрозділів

```{r}
fig8
```

Row {data-height=500}
-----------------------------------------------------

### Оборотність планограм (відношення продажу за місяць до фейсу з нормою)

```{r}
fig9
```

### Аналіз цінових груп по категорійним напрямкам (порівняння планограм із продажами) {.no-padding}

```{r}
fig10
```

```{css}
.value-box .value {
    font-size: 30px;
}
.value-box .caption {
  font-size: 12px;
}
```

Аналіз SKU {data-icon="fa-box"}
=======================================================================

Row {data-height=100}
-----------------------------------------------------
### Загальна кількість SKU

```{r}
valueBox(
  value = format(total_sku, big.mark="'"),
  color = "info"
)
```

### Кількість SKU основного асортименту

```{r}
valueBox(
  value = format(total_active_sku, big.mark="'"),
  color = case_when(
                    total_active_sku / total_sku  < 0.6 ~ "danger",
                    total_active_sku / total_sku  < 0.75 ~ "warning",
                    total_active_sku / total_sku >= 0.75 ~ "success"
                    )
)
```

### Кількість ТВА

```{r}
valueBox(
  value = format(total_tva_sku, big.mark="'"),
  color = case_when(
                    total_tva_sku / total_sku  > 0.2 ~ "danger",
                    total_tva_sku / total_sku  > 0.1 ~ "warning",
                    total_tva_sku / total_sku <= 0.1 ~ "success"
                    )
)
```

### Кількість нових SKU за звітний місяць

```{r}
valueBox(
  value = format(total_new_sku, big.mark="'"),
  color = "info"
)
```

### Кількість SKU без продажу (осн.асорт.)

```{r}
valueBox(
  value = format(total_sku_without_sale, big.mark="'"),
  color = case_when(
                    total_sku_without_sale / total_active_sku  > 0.3 ~ "danger",
                    total_sku_without_sale / total_active_sku  > 0.2 ~ "warning",
                    total_sku_without_sale / total_active_sku <= 0.2 ~ "success"
                    )
)
```

### Кількість SKU з продажем

```{r}
valueBox(
  value = format(total_sale_sku, big.mark="'"),
  color = case_when(
                    total_sale_sku / total_sku  < 0.6 ~ "danger",
                    total_sale_sku / total_sku  < 0.75 ~ "warning",
                    total_sale_sku / total_sku >= 0.75 ~ "success"
                    )
)
```

Row {data-height=400}
-----------------------------------------------------
### Графік Парето {.no-padding}

```{r}
fig11
```

### Структура залишків за категорійними напрямками {.no-padding}

```{r}
fig12
```

Row {data-height=500}
-----------------------------------------------------
### Аналіз залишків з SKU на кінець місяця за підрозділами

```{r}
fig_subdiv_sku_analysis
```

### Аналіз SKU основного асортименту за підрозділами

```{r}
fig_main_range
```

Row {data-height=600}
-----------------------------------------------------
### Дані з SKU за звітний місяць по КН/КМ

```{r}
table1
```


Постачальники {data-icon="fa-handshake"}
=======================================================================

Row {data-height=100}
-----------------------------------------------------
### Загальна кількість постачальників

```{r}
valueBox(
  value = current_month_suppl_qty,
  color = "info"
)
```

### Загальна сума кредиторської заборгованості постачальникам

```{r}
valueBox(
  value = paste0(format(current_month_debt, big.mark="'"), "тис.грн"),
  color = "info"
)
```

### Загальна сума викупленого товару

```{r}
valueBox(
  value = paste0(format(redeemed_goods_current_month, big.mark="'"), "тис.грн"),
  color = "info"
)
```

Row {data-height=150}
-----------------------------------------------------
### Загальна кількість постачальників з початку року

```{r}
ggplotly(fig13, tooltip = "text") %>% 
    config(displayModeBar = FALSE)
```

### Cума кредиторської заборгованості постачальникам з початку року

```{r}
ggplotly(fig15, tooltip = "text") %>% 
    config(displayModeBar = FALSE)
```

### Загальна сума викупленого товару з початку року

```{r}
ggplotly(fig16, tooltip = "text") %>% 
    config(displayModeBar = FALSE)
```

Row {data-height=300}
-----------------------------------------------------
### ТОП-5 постачальників за сумою за звітний місяць

```{r}
fig17
```


### ТОП-5 постачальників за сумою кредиторської заборгованості

```{r}
fig19
```

### ТОП-5 постачальників за сумою викупленого товару

```{r}
fig20
```

Row {data-height=100}
-----------------------------------------------------

### Середньозважений час виконання замовлення постачальниками

```{r}
valueBox(
  value = paste0(current_month_lead_time, "дн."),
  color = case_when(
                    current_month_lead_time  > 10 ~ "danger",
                    current_month_lead_time  > 5 ~ "warning",
                    current_month_lead_time <= 5 ~ "success"
                    )
)
```

### Частка SKU, які надійшли вчасно (On Time)

```{r}
valueBox(
  value = scales::percent(current_month_on_time, accuracy = 0.1),
  color = case_when(
                    current_month_on_time  < 0.6 ~ "danger",
                    current_month_on_time  < 0.7 ~ "warning",
                    current_month_on_time >= 0.7 ~ "success"
                    )
)
```

### Частка SKU, які надійшли в повному обсязі (In Full)

```{r}
valueBox(
  value = scales::percent(current_month_in_full, accuracy = 0.1),
  color = case_when(
                    current_month_in_full  < 0.7 ~ "danger",
                    current_month_in_full  < 0.8 ~ "warning",
                    current_month_in_full >= 0.8 ~ "success"
                    )
)
```

Row {data-height=150}
-----------------------------------------------------

### Середньозважений час виконання замовлення з початку року

```{r}
ggplotly(fig14, tooltip = "text") %>% 
    config(displayModeBar = FALSE)
```

### Cвоєчасність надходжень (On Time) з початку року

```{r}
ggplotly(fig21, tooltip = "text") %>% 
    config(displayModeBar = FALSE)
```

### Кількісна відповідність надходжень (In Full) з початку року

```{r}
ggplotly(fig22, tooltip = "text") %>% 
    config(displayModeBar = FALSE)
```

Row {data-height=300}
-----------------------------------------------------
### ТОП-5 постачальників з найбільшим часом виконання замовлення

```{r}
fig18
```

### Найгірші постачальники за своєчасністю надходжень (>1000од.)

```{r}
fig23
```

### Найгірші постачальники за кількісною відповідністю надходжень (>1000од.)

```{r}
fig24
```