---
title: "Звіт з В2С за `r lubridate::month(lubridate::rollback(Sys.Date()), label = TRUE, abbr = FALSE)`"
output: 
  flexdashboard::flex_dashboard:
     orientation: rows
     vertical_layout: scroll
     theme:
      version: 4
      navbar-bg: "red"
---

```{r setup, include=FALSE}
library(flexdashboard)
library(tidyverse)
library(lubridate)
library(reactablefmtr)
library(httr)
library(jsonlite)
```

```{r preparation}
source("global.R", local = FALSE)
rm(list = ls(pattern = "tbl", all.names = TRUE))

date_start <- rollback(Sys.Date(), roll_to_first = TRUE) - months(1)
date_finish <- date_start + months(1)


area_data <- get_shop_area() %>% 
    select(-date) %>% 
    pivot_wider(names_from = type_area,
                values_from = area_value)

sale_check_data <- checks_data(date_start + years(2000),
                               date_finish + years(2000))

empl_work_time_data <- work_time_data(date_start + years(2000),
                                      date_finish + years(2000))


cost_raw_data <- cost_data(date_start + years(2000),
                     date_finish + years(2000)) %>% 
    filter(!is.na(nmbr_check_doc)) %>%
    mutate(subdiv_name = ifelse(subdiv_name == "Копіцентр ХМ СМ",
                                "Хмельницький см роздріб",
                                subdiv_name))

sale_plan_df <- sale_plan_data(date_start + years(2000),
                          date_finish + years(2000)) %>% 
    filter(project == "Розница") %>% 
    mutate(subdiv_name = ifelse(subdiv_name == "Копіцентр ХМ СМ",
                                "Хмельницький см роздріб",
                                subdiv_name)) %>% 
    group_by(subdiv_name) %>% 
    summarise(plan_sum = sum(saleplan_doc_sum))

plan_indicators <- plan_data(date_start + years(2000),
                             date_finish + years(2000)) %>% 
    filter(indicator_name %in% c("КількістьЧеківПлан",
                                 "План продаж,шт В2С")) %>% 
    select(-plan_period) %>% 
    pivot_wider(names_from = indicator_name,
                values_from = value)

plan_ind_nrow <- nrow(plan_indicators)


sale_history <- checks_data_global(date_start + years(2000) - months(35),
                                   date_finish + years(2000)) %>% 
    mutate(date = as.Date(date) - years(2000))


regular_cust <- regular_cust_data(date_start,
                                  date_finish) %>% 
    group_by(store_1c) %>% 
    summarise(total_regular_checks = sum(items_count > 0),
              total_reg_cust = n_distinct(client),
              reg_cust_reduce_sum =  - sum(discounts_amount),
              reg_cust_bonus_acrrued = sum(discounts_account_amount),
              reg_cust_bonus_reduced = - sum(amount_2)) %>% 
    mutate(reg_cust_discounts = reg_cust_reduce_sum - reg_cust_bonus_reduced) %>% 
    left_join(select(ref_store, store_id, subdiv_name),
              by = c("store_1c" = "store_id")) %>% 
    relocate(subdiv_name, .after = store_1c) %>% 
    select(-store_1c)


plan_retail_data <- sale_plan_retail(date_start + years(2000),
                                     date_finish + years(2000)) %>% 
    group_by(subdiv_name) %>% 
    summarise(plan_revenue = sum(plan_sale),
              plan_profit = sum(plan_profit))
```

```{r main_indicators}
sale_check_df <- sale_check_data %>% 
    group_by(date, subdiv_name, cashbox, check_nmbr) %>% 
    summarise(check_sum = sum(sum),
              check_discount = round(sum(price * qty) - check_sum, 2),
              sum_moneybox = sum(sum[item_id == "000532240"]), # в Скарбничку
              check_items = n(),
              check_items_clr = check_items - (sum_moneybox > 0),
              check_qty = sum(qty),
              check_time = first(check_time)
    ) %>% 
    ungroup() %>% 
    mutate(date = as.Date(date) - years(2000))


work_duration <- sale_check_df %>% 
    filter(subdiv_name != "Копіцентр ХМ СМ") %>% 
    group_by(subdiv_name, date) %>% 
    summarise(checks = n(),
              first_check = min(check_time[check_time != ""]),
              last_check = max(check_time)) %>% 
    ungroup() %>% 
    mutate(weekday = wday(date, label = TRUE)) %>% 
    left_join(select(ref_shops, subdiv_name, weekday, start_work, finish_work)) %>% 
    mutate(diff_first = as.integer(make_difftime(
                      hms::as_hms(first_check) - start_work, units = "hour")),
           diff_last = as.integer(make_difftime(
                   hms::as_hms(last_check) - finish_work, units = "hour")),
           work_duration = as.integer(finish_work - start_work) / 3600 -
               diff_first + diff_last) %>% 
    group_by(subdiv_name) %>% 
    summarise(period_work_time = sum(work_duration))

empl_work_time_retail <- empl_work_time_data %>%
    filter(!position_id %in% c("000000049", "000000036", "000000200",
                               "000000041")) %>% 
    left_join(unique(select(ref_shops, subdiv_name, parent_shop))) %>% 
    filter(!is.na(parent_shop)) %>% 
    mutate(working_hours = ifelse(position_id == "000000031" &
                                      (parent_shop %in% c("Группа А",
                                                          "Группа Б",
                                                          "Группа С",
                                                          "Группа Д") &
                                      !subdiv_name %in% c("Володимир Волинський",
                                                          "Луцьк Ковельськ",
                                                          "Чернівці")),
                                  working_hours * 0.2,
                                  working_hours)) %>% 
    group_by(subdiv_name) %>% 
    summarise(subdiv_empl_work_time = sum(working_hours))


cost_df <- cost_raw_data %>%
    group_by(subdiv_name) %>% 
    summarise(total_cost = sum(item_sum) + sum(item_vat))


sale_prev_year <- sale_history %>% 
    filter(date >= date_start -  years(1),
           date <  date_finish - years(1)) %>% 
    mutate(subdiv_name = ifelse(subdiv_name %in% c("Копіцентр ХМ СМ",
                                                   "Подарунки ХМ СМ"),
                                "Хмельницький см роздріб",
                                subdiv_name)) %>% 
    group_by(subdiv_name) %>% 
    summarise(revenue_prev_year = sum(checks_sum),
              checks_prev_year = sum(checks_qty))


retail_df <- sale_check_df %>% 
    mutate(subdiv_name = ifelse(subdiv_name == "Копіцентр ХМ СМ",
                                "Хмельницький см роздріб",
                                subdiv_name)) %>% 
    group_by(subdiv_name) %>% 
    summarise(revenue = sum(check_sum),
              discounts = sum(check_discount),
              total_checks = sum(check_sum > 0),
              one_item_checks_qty = sum(check_items_clr == 1),
              total_items = sum(check_items_clr),
              total_units = sum(check_qty),
              avr_unit_sum = round(revenue / total_units, 1)
    ) %>% 
    ungroup() %>% 
    left_join(distinct(select(ref_shops, subdiv_name, parent_shop),
                       subdiv_name, .keep_all = TRUE)) %>% 
    left_join(select(area_data, subdiv_name:trade_area)) %>% 
    left_join(cost_df) %>% 
    left_join(work_duration) %>%
    left_join(empl_work_time_retail) %>%
    left_join(sale_plan_df) %>% 
    left_join(plan_indicators) %>% 
    left_join(sale_prev_year) %>%
    left_join(regular_cust) %>%
    mutate(across(where(is.numeric), ~ifelse(is.na(.), 0, .))) %>% 
    janitor::adorn_totals(where = "row", name = "ВСЕГО") %>%
    mutate(plan_implement = round(revenue / plan_sum, 3),
           revenue_change = ifelse(revenue_prev_year > 0,
                                   round(revenue / revenue_prev_year - 1, 3),
                                   0),
           checks_nmbr_impl = ifelse(plan_ind_nrow > 0,
                                     round(total_checks / `КількістьЧеківПлан`,
                                           3),
                                     0),
           total_checks_change = ifelse(checks_prev_year > 0,
                                        round(total_checks / 
                                                  checks_prev_year - 1, 3),
                                        0),
           one_item_checks_share = round(one_item_checks_qty/total_checks, 3),
           avr_check_sum = round(revenue / total_checks, 1),
           avr_check_impl = ifelse(plan_ind_nrow > 0,
                                   round(avr_check_sum /
                                      (plan_sum / `КількістьЧеківПлан`), 3),
                                   0),
           avr_check_change = ifelse(checks_prev_year > 0,
                                     round(avr_check_sum / (revenue_prev_year /
                                                         checks_prev_year) - 1,
                                           3),
                                     0),
           avr_check_sku = round(total_items / total_checks, 1),
           avr_check_sku_impl = ifelse(plan_ind_nrow > 0,
                                       round(avr_check_sku /
                                           (`План продаж,шт В2С`), 3),
                                       0),
           share_regular_cust = round(total_regular_checks / total_checks, 3),
           net_discount = discounts - reg_cust_bonus_reduced,
           net_discount_share = round(net_discount / revenue, 3),
           rev_per_sq = round(revenue / trade_area),
           gross_profit = revenue - total_cost,
           profitability = round(gross_profit / revenue, 3),
           gmros = round(gross_profit / trade_area),
           gmrol = round(gross_profit / subdiv_empl_work_time),
           row_n = row_number(),
           staff_factor = subdiv_empl_work_time / period_work_time,
           
           staff_factor = ifelse(row_n == max(row_n),
                                 sum(staff_factor) - staff_factor,
                                 staff_factor),
           service_factor = round(total_checks / pmax(staff_factor, 1)),
           area_served = round(trade_area / staff_factor))


total_shops <- nrow(retail_df) - 1

sale_plan_inplemention <- retail_df$plan_implement[total_shops + 1] * 100

retail_plan_profit <- sum(plan_retail_data$plan_profit)

profit_implement <- round(retail_df$gross_profit[nrow(retail_df)] / 
                          retail_plan_profit, 3)

total_profitability <- retail_df$profitability[nrow(retail_df)] * 100

revenue_per_area <- retail_df$rev_per_sq[total_shops + 1]

total_gmros <- retail_df$gmros[total_shops + 1]
```

```{r checks_data}
checks_nmbr_inplemention <- retail_df$checks_nmbr_impl[total_shops + 1] * 100
avr_check_inplemention <- retail_df$avr_check_impl[total_shops + 1] * 100
avr_check_sku_plan <- ifelse(plan_ind_nrow > 0,
                             round(weighted.mean(
                                retail_df$`План продаж,шт В2С`[1:total_shops],
                                retail_df$plan_sum[1:total_shops]),
                                2),
                             0)
avr_check_sku_inplemention <- ifelse(plan_ind_nrow > 0,
                              round(retail_df$avr_check_sku[total_shops + 1] /
                                    avr_check_sku_plan * 100, 1),
                              0)
avr_check_plan <- ifelse(plan_ind_nrow > 0,
                         round(retail_df$plan_sum[total_shops + 1] /
                            retail_df$`КількістьЧеківПлан`[total_shops + 1], 1),
                         0)

last_4week_data <- sale_check_df %>% 
    filter(date >= date_finish - days(28)) %>% 
    mutate(week_last_day = case_when(
                       date >= date_finish - days(7)  ~ date_finish - days(1),
                       date >= date_finish - days(14) ~ date_finish - days(8),
                       date >= date_finish - days(21) ~ date_finish - days(15),
                       date >= date_finish - days(28) ~ date_finish - days(22))
           ) %>% 
    group_by(week_last_day) %>% 
    summarise(revenue = sum(check_sum),
              total_checks = sum(check_sum > 0),
              total_items = sum(check_items_clr)) %>% 
    mutate(avr_check = round(revenue / total_checks, 1),
           avr_check_sku = round(total_items / total_checks, 1))
```

```{r staff_data}
total_gmrol <- retail_df$gmrol[total_shops + 1]
total_service_factor <- retail_df$service_factor[total_shops + 1]
total_area_served <- retail_df$area_served[total_shops + 1]
```

```{r assortment_data}
items_data <- sale_check_data %>% 
    filter(qty > 0) %>% 
    mutate(subdiv_name = ifelse(subdiv_name == "Копіцентр ХМ СМ",
                                "Хмельницький см роздріб",
                                subdiv_name)) %>% 
    group_by(subdiv_name, item_id) %>% 
    summarise(item_checks_nmbr = n(),
              item_sale_sum = sum(sum)) %>% 
    ungroup() %>% 
    left_join(select(ref_items, item_id, item_name, group_id)) %>% 
    filter(!group_id %in% c("000001912", # Бонус (в Скарбничку)
                            "000000504", # Пакети
                            "000003220", # Пакети фасув
                            "000003368", # Друк Ч/Б
                            "000001899"  # Друк кольоp
    ),
    !is.na(group_id)             # Дисконтная карта
    )

items_df <- items_data %>% 
    group_by(item_name) %>% 
    summarise(item_checks = sum(item_checks_nmbr),
              item_total_sale = sum(item_sale_sum),
              subdiv_nmbr = n())

cost_category <- cost_raw_data %>% 
    left_join(select(ref_items, item_id, group_id)) %>% 
    left_join(select(ref_item_group, group_id, category_name)) %>% 
    group_by(subdiv_name, category_name) %>% 
    summarise(category_cost_sum = sum(item_sum) + sum(item_vat)) %>% 
    filter(!is.na(category_name))

sale_category_raw <- sale_check_data %>% 
    mutate(subdiv_name = ifelse(subdiv_name == "Копіцентр ХМ СМ",
                                "Хмельницький см роздріб",
                                subdiv_name)) %>%
    left_join(select(ref_items, item_id, group_id)) %>% 
    left_join(select(ref_item_group, group_id, category_name)) %>% 
    group_by(subdiv_name, date, cashbox, check_nmbr, category_name) %>% 
    summarise(category_check_sale = sum(sum)) %>% 
    filter(!is.na(category_name))

sale_category <- sale_category_raw %>% 
    group_by(subdiv_name, category_name) %>% 
    summarise(category_sale_sum = sum(category_check_sale)) %>% 
    left_join(cost_category)

p <- items_data %>%
    group_by(subdiv_name) %>% 
    summarise(items_nmbr = n()) %>% 
    left_join(distinct(select(ref_shops, subdiv_name, parent_shop),
                       subdiv_name, .keep_all = TRUE)) %>% 
    ggplot(aes(x = reorder(subdiv_name, items_nmbr),
               y = items_nmbr, fill = parent_shop)) +
    geom_bar(stat="identity") +
    scale_fill_viridis_d() +
    labs(x = "", y = "Кількість проданих SKU", fill = "Категорія") +
    coord_flip()+
    theme_minimal() +
    theme(axis.text.x = element_text(size = 8),
          axis.text.y = element_text(size = 8),
          legend.text = element_text(size = 8),
          panel.grid.major.y = element_blank())

items_qty <- nrow(items_df)

g <- items_df %>% 
    select(item_name, item_total_sale) %>% 
    arrange(desc(item_total_sale)) %>%
    mutate(
        pct = item_total_sale / sum(item_total_sale),
        cumulative_pct = cumsum(pct),
        importance_product = ifelse(cumulative_pct <= 0.8, "Так", "Ні")
    ) %>%
    rowid_to_column(var = "rank") %>% 
    mutate(label_text = str_glue(
        "Ранг: {rank}
         Товар: {item_name}
         Сума: {item_total_sale}
         Доля: {scales::percent(pct, accuracy = 0.01)}
         Кумул.доля: {scales::percent(cumulative_pct, accuracy = 0.01)}")) %>% 
    ggplot(aes(rank, cumulative_pct)) +
    geom_point(aes(color = importance_product, text = label_text), alpha = 0.2) +
    scale_y_continuous(label = scales::percent) +
    theme_minimal() +
    theme(#legend.direction = "vertical", 
          legend.position  = "top") +
    labs(title = paste0("Загальна кількість проданих товарів - ", items_qty), 
         x = "Кількість SKU",
         y = "Частка у продажах",
         color = "ТОП-80%")
```

```{r additional_info_data}

category_checks <- sale_category_raw %>% 
    group_by(subdiv_name, category_name) %>% 
    summarise(category_checks = n()) %>% 
    ungroup() %>% 
    filter(!category_name %in% c("15. Копіцентр",
                                "08. Стільці та крісла",
                                "09. Меблі в офіс")) %>% 
    pivot_wider(names_from  = category_name,
                values_from = category_checks,
                values_fill = 0) %>% 
    column_to_rownames(var = "subdiv_name")

res.agnes <- cluster::agnes(x = category_checks,
                            stand = TRUE,
                            metric = "euclidean",
                            method = "ward",
                            keep.data = TRUE)


checks_time <- sale_check_data %>% 
    filter(qty > 0) %>% 
    mutate(subdiv_name = ifelse(subdiv_name == "Копіцентр ХМ СМ",
                                "Хмельницький см роздріб",
                                subdiv_name)) %>%
    distinct(date, subdiv_name, cashbox, check_nmbr, check_time) %>% 
    mutate(check_time = as.character(substr(check_time, 1, 2)),
           week_day = wday(as.Date(date) - years(2000),
                           label = TRUE,
                           week_start = getOption("lubridate.week.start", 1))) %>%
    filter(check_time != "")


population <- readxl::read_xlsx("data/Геоданные_население.xlsx") %>% 
    filter(!is.na(longtitude)) %>% 
    mutate(latitude = as.numeric(latitude),
           longtitude = as.numeric(longtitude),
           town_name = str_extract(UKR_NAME,
                                   "(?<=м\\.\\s?|смт\\s?)\\S[^,]+")) %>% 
    select(-c(EN_NAME, UKR_NAME))

map_df <- retail_df %>% 
    select(subdiv_name, revenue) %>%
    filter(subdiv_name != "ВСЕГО") %>% 
    left_join(distinct(select(ref_store, subdiv_name, store_location),
              subdiv_name, .keep_all =TRUE)) %>% 
    mutate(subdiv_town = str_extract(store_location,
                                     "(?<=м\\.\\s?|смт\\.\\s?)\\S[^,]+(?=,)")) %>% 
    group_by(subdiv_town) %>% 
    summarise(town_revenue = sum(revenue)) %>%
    ungroup() %>% 
    left_join(population,
              by = c("subdiv_town" = "town_name")) %>% 
    mutate(revenue_per_popul = round(town_revenue / population, 1))

checks_time_count <- checks_time %>% 
    filter(subdiv_name == "Хмельницький см роздріб") %>% 
    mutate(date = as.Date(date) - years(2000)) %>% 
    count(subdiv_name, date)


call <- paste0("http://w2.intelpol.com.ua/api.php?date_from=",
               as.character(date_start),
               "&date_to=",
               as.character(date_finish - days(1)),
               "&token=415a91dd3377898ef7516d41096a0585")

get_info <- GET(call)
get_info_text <- content(get_info, "text")
get_info_json <- fromJSON(get_info_text)

df_passability_raw <- get_info_json %>% 
    map(bind_rows) %>%
    bind_rows(.id = 'name')

df_passability <- df_passability_raw$stores %>% 
    map(bind_rows) %>%
    bind_rows(.id = 'name') %>% 
    unnest_wider(zones) %>% 
    unnest_longer(stats) %>% 
    unnest_wider(stats) %>% 
    mutate(across(5:(ncol(.)-1), ~ifelse(is.na(.), 0, .)),
           across(5:(ncol(.)-1), as.integer),
           date = as.Date(stats_id), .after = name_zone) %>% 
    select(-c(stats_id, name, num_store))

passability_by_day <- df_passability %>% 
    mutate(day_visitors = rowSums(across(where(is.integer)))) %>% 
    # filter(str_detect(name_zone, "1\\.\\(Вход\\)")) %>% 
    filter(day_visitors > 10) %>%
    group_by(date) %>%
    filter(n() == 4) %>% 
    summarise(day_visitors = sum(day_visitors) / 2 - (10 + 10) * 2) %>%
    left_join(select(checks_time_count, date, n)) %>% 
    filter(!is.na(n)) %>% 
    mutate(conversion = round(n / day_visitors, 3),
           not_bought = day_visitors - n)

total_conversion <- round(mean(passability_by_day$conversion) * 100)
```


Основні показники {data-icon="fa-bullseye"}
=======================================================================

Row {data-height=150}
-----------------------------------------------------------------------

### Виторг - `r round(retail_df$revenue[nrow(retail_df)] / 1000000, 2)`млн.грн  

```{r}
gauge(sale_plan_inplemention, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(95, 100), warning = c(80, 94.9), danger = c(0, 79.9)
))
```

### Валовий прибуток `r round(retail_df$gross_profit[nrow(retail_df)] / 1000000, 2)` (млн.грн) 

```{r}
gauge(round(profit_implement * 100, 1), min = 0, max = 100,
      symbol = '%', gaugeSectors(
           success = c(95, 100), warning = c(80, 94.9), danger = c(0, 79.9))
)
```

### GMROS торг.площі (грн/м^2^)

```{r}
valueBox(
  value = format(total_gmros, big.mark="'"),
  icon  = "fa-calculator",
  color = case_when(
                    sale_plan_inplemention < 80  ~ "danger",
                    sale_plan_inplemention < 95  ~ "warning",
                    sale_plan_inplemention >= 95 ~ "success"
                    )
)
```


Row {data-height=400}
-----------------------------------------------------------------------
### Щомісячний виторг за останні 3 роки (млн.грн)) {data-width=400}

```{r}
sale_history_by_year <- sale_history %>% 
    group_by(date) %>% 
    summarise(revenue = round(sum(checks_sum) / 1000000, 2),
              checks_nmbr = sum(checks_qty))

library(timetk)
sale_history_by_year %>% 
    summarise_by_time(date, .by = "month", sales = sum(revenue)) %>% 
    plot_time_series(date, sales,
                     #.facet_scales = "free",
                     .title = "",
                     .interactive = TRUE)
```

### Рентабельність продажів по підрозділам (ТОП-3) {data-width=400}

```{r}
retail_df %>% 
    select(subdiv_name, profitability) %>% 
    filter(subdiv_name != "ВСЕГО") %>% 
    arrange(profitability) %>% 
    filter(between(row_number(), 1, 3) | between(row_number(),total_shops-2,
                                                 total_shops)) %>%
    mutate(type = ifelse(row_number() <= 3,
                         "bottom",
                         "top")) %>% 
    ggplot(aes(x = reorder(subdiv_name, profitability), y = profitability,
               fill = type)) +
    geom_col() +
    scale_y_continuous(breaks = seq(0, 1, .2), 
                       label = scales::percent) +
    geom_text(aes(label = scales::percent(profitability), y = profitability / 2),
              size = 4.5) +
    scale_fill_manual(values = c("salmon", "yellowgreen")) +
    labs(x = "", y = "",
         title = paste0("Загальна рентабельність - ", total_profitability, "%")) +
    coord_flip() +
    theme_minimal() +
    theme(legend.position="none",
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          panel.grid = element_blank())
```

### GMROS (грн/м^3^) {data-width=400}

```{r}
retail_df %>% 
    select(subdiv_name, gmros) %>% 
    filter(subdiv_name != "ВСЕГО") %>% 
    arrange(gmros) %>% 
    filter(between(row_number(), 1, 3) | between(row_number(),total_shops-2,
                                                 total_shops)) %>%
    mutate(type = ifelse(row_number() <= 3,
                         "bottom",
                         "top")) %>% 
    ggplot(aes(x = reorder(subdiv_name, gmros), y = gmros, fill = type)) +
    geom_col() +
    geom_text(aes(label = format(gmros, big.mark="'"), y = gmros / 2),
              size = 4) +
    scale_fill_manual(values = c("salmon", "yellowgreen")) +
    labs(x = "", y = "") +
    coord_flip() +
    theme_minimal() +
    theme(legend.position="none",
          axis.text.y = element_text(size = 12),
          axis.text.x = element_blank(),
          panel.grid = element_blank())
```


Row
-----------------------------------------------------------------------

### Дані {data-width=1000}

```{r}
mean_gmros <- mean(retail_df$gmros[1:total_shops])

retail_df %>% 
    select(subdiv_name, parent_shop, trade_area, revenue, revenue_change, 
           net_discount_share, rev_per_sq, gross_profit, profitability, gmros) %>% 
    filter(subdiv_name != "ВСЕГО") %>%
    replace_na(list(revenue_change = 0)) %>% 
    reactable(striped = TRUE,
        groupBy = c("parent_shop"),
        columns = list(
            parent_shop = colDef(name = "Група"),
            subdiv_name = colDef(name = "Магазин"),
            trade_area = colDef(name = "Торг.площа",
                                      aggregate = "sum",
                                      maxWidth = 70,
                                      format = colFormat(separators = TRUE,
                                                         digits = 0)),
            revenue = colDef(aggregate = "sum",
                             name = "Виторг",
                             minWidth = 60,
                             format = colFormat(separators = TRUE,
                                                digits = 0)),
            revenue_change = colDef(name = "Зм.(рік)",
                                    maxWidth = 65, 
                          style = function(value) {
                                          color <- if (value > 0) {
                                              "#008000"
                                          } else if (value < 0) {
                                              "#e00000"
                                          }
                                          list(color = color, fontSize = 14)
                                      },
                          format = colFormat(percent = TRUE, digits = 1)),
            net_discount_share = colDef(name = "Знижки",
                                    maxWidth = 80,
                                    format = colFormat(percent = TRUE)),
            rev_per_sq = colDef(name = "Виторг 1м2",
                                minWidth = 50,
                                aggregate = JS("function(values, rows) {
                                    let totalRevenue = 0
                                    let totalArea = 0
                                    rows.forEach(function(row) {
                                        totalRevenue += row['revenue']
                                        totalArea += row['trade_area']
                                        })
                                    return totalRevenue / totalArea
                                    }"),
                                format = colFormat(separators = TRUE,
                                                     digits = 0),
                                cell = color_tiles(.,
                                                   number_fmt = scales::label_comma(big.mark = " "),
                                                   colors = c('salmon',
                                                              'white',
                                                              'yellowgreen'))
                ),
            gross_profit = colDef(aggregate = "sum",
                                  name = "Вал.приб.",
                                  minWidth = 60,
                                  format = colFormat(separators = TRUE,
                                                     digits = 0)),
            profitability = colDef(name = "Рентаб.",
                                   minWidth = 50,
                                   aggregate = JS("function(values, rows) {
                                    let totalProfit = 0
                                    let totalRevenue = 0
                                    rows.forEach(function(row) {
                                        totalProfit += row['gross_profit']
                                        totalRevenue += row['revenue']
                                        })
                                    return totalProfit / totalRevenue
                                    }"),
                                   format = colFormat(percent = TRUE,
                                                      digits = 1)),
            gmros = colDef(name = "GMROS",
                           minWidth = 50,
                           aggregate = JS("function(values, rows) {
                                    let totalProfit = 0
                                    let totalArea = 0
                                    rows.forEach(function(row) {
                                        totalProfit += row['gross_profit']
                                        totalArea += row['trade_area']
                                        })
                                    return totalProfit / totalArea
                                    }"),
                           format = colFormat(separators = TRUE,
                                                     digits = 0),
                           cell = color_tiles(.,
                                              number_fmt = scales::label_comma(big.mark = " "),
                                              colors = c('salmon','white',
                                                         'yellowgreen'))
            )
        ),
        bordered = TRUE
    )
```


Чеки {data-icon="fa-cart-arrow-down"}
=======================================================================

Row {data-height=150}
-----------------------------------------------------------------------

### Кільксть чеків

```{r}
gauge(checks_nmbr_inplemention, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(95, 100), warning = c(80, 94.9), danger = c(0, 79.9)
))
```

### Середній чек - `r retail_df$avr_check_sum[total_shops + 1]`грн

```{r}
gauge(avr_check_inplemention, min = 0, max = 100, symbol = '%', gaugeSectors(
  success = c(95, 100), warning = c(80, 94.9), danger = c(0, 79.9)
))
```

### SKU у чеку - `r retail_df$avr_check_sku[total_shops + 1]`

```{r}
gauge(avr_check_sku_inplemention, min = 0, max = 100, symbol ='%', gaugeSectors(
  success = c(95, 100), warning = c(80, 94.9), danger = c(0, 79.9)
))
```

Row {data-height=400}
-----------------------------------------------------------------------

### Кількість чеків за останні 3 роки {data-width=400}

```{r}
sale_history_by_year %>% 
    summarise_by_time(date, .by = "month", sales = sum(checks_nmbr)) %>% 
    plot_time_series(date, sales, .facet_ncol = 2, .smooth_span = 1,
                     .smooth_period = "auto",
                     .facet_scales = "free",
                     .title = "",
                     .interactive = TRUE)
```

### Зміна середнього чеку за останні 4 тижня {data-width=400}

```{r}
last_4week_data %>% 
    ggplot(aes(x = week_last_day, y = avr_check)) +
    geom_point(aes(colour = "steelblue")) +
    geom_line(aes(colour = "steelblue"),
                  size = 1) +
    geom_hline(aes(yintercept = avr_check_plan,
                   colour = "darkred"),
               linetype = "dashed",
               size = 1) +
    ggplot2::annotate("text", 
                      last_4week_data$week_last_day[2], 
                      avr_check_plan + 1, 
                      label = "План",
                      color = "darkred",
                      size = 5) +
    labs(x = "", y = "") +
    theme_minimal() +
    theme(legend.position="none",
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12))
```

### Зміна кількості SKU у чеку за останні 4 тижні {data-width=400}

```{r}
last_4week_data %>% 
    ggplot(aes(x = week_last_day, y = avr_check_sku)) +
    geom_point(aes(colour = "steelblue")) +
    geom_line(aes(colour = "steelblue"),
                  size = 1) +
    geom_hline(aes(yintercept = avr_check_sku_plan,
                   colour = "darkred"),
               linetype = "dashed",
               size = 1) +
    ggplot2::annotate("text", 
                      last_4week_data$week_last_day[2], 
                      avr_check_sku_plan + 0.1, 
                      label = "План",
                      color = "darkred",
                      size = 5) +
    labs(x = "", y = "") +
    theme_minimal() +
    theme(legend.position="none",
          axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12))
```


Row
-----------------------------------------------------------------------

### Дані {data-width=1000}

```{r}
retail_df %>%
    select(subdiv_name, parent_shop, revenue, total_checks, total_checks_change,
           one_item_checks_share, share_regular_cust, avr_check_sum, 
           avr_check_change, avr_check_sku, avr_unit_sum,
           reg_cust_bonus_reduced, reg_cust_bonus_acrrued) %>%
    filter(subdiv_name != "ВСЕГО") %>%
    replace_na(list(total_checks_change = 0,
                    avr_check_change = 0)) %>%
    reactable(striped = TRUE,
        groupBy = c("parent_shop"),
        columns = list(
            parent_shop = colDef(name = "Категорія"),
            subdiv_name = colDef(name = "Магазин"),
            revenue = colDef(aggregate = "sum",
                             name = "Виторг",
                             minWidth = 60,
                             format = colFormat(separators = TRUE,
                                                digits = 0)),
            total_checks = colDef(aggregate = "sum",
                                  name = "Кількість",
                                  minWidth = 60,
                                  format = colFormat(separators = TRUE,
                                                     digits = 0)),
            total_checks_change = colDef(
                name = "Зм.(рік)",
                maxWidth = 60, 
                style = function(value) {
                                          color <- if (value > 0) {
                                              "#008000"
                                          } else if (value < 0) {
                                              "#e00000"
                                          }
                                          list(color = color, fontSize = 14)
                                      },
                format = colFormat(percent = TRUE)),
            one_item_checks_share = colDef(name = "1SKU",
                                           minWidth = 50,
                                           format = colFormat(percent = TRUE)),
            share_regular_cust = colDef(name = "Частка пост.",
                                        minWidth = 60,
                                        format = colFormat(percent = TRUE)),
            avr_check_sum = colDef(name = "Сума",
                                   minWidth = 50,
                                   aggregate = JS("function(values, rows) {
                                       let totalRevenue = 0
                                       let totalChecks = 0
                                       rows.forEach(function(row) {
                                           totalRevenue += row['revenue']
                                           totalChecks += row['total_checks']
                                           })
                                       return totalRevenue / totalChecks
                                       }"),
                              format = colFormat(digits = 1),
                              cell = color_tiles(.,
                                                 number_fmt = scales::label_comma(big.mark = " "),
                                                 colors = c('salmon',
                                                            'white',
                                                            'yellowgreen'))
                ),
           avr_check_change = colDef(
                name = "Зм.(рік)",
                maxWidth = 60, 
                style = function(value) {
                                          color <- if (value > 0) {
                                              "#008000"
                                          } else if (value < 0) {
                                              "#e00000"
                                          }
                                          list(color = color, fontSize = 14)
                                      },
                format = colFormat(percent = TRUE)), 
           avr_check_sku = colDef(aggregate = "mean",
                                  name = "Кіл.SKU",
                                  minWidth = 50,
                                  format = colFormat(digits = 1)),
           avr_unit_sum = colDef(aggregate = "mean",
                                 name = "Сер.ціна од.",
                                 minWidth = 60,
                                 format = colFormat(digits = 1)),
           reg_cust_bonus_acrrued = colDef(aggregate = "sum",
                                           name = "Нарах.",
                                           minWidth = 50,
                                           format = colFormat(separators = TRUE,
                                                              digits = 0)),
           reg_cust_bonus_reduced = colDef(aggregate = "sum",
                                           name = "Виплач.",
                                           minWidth = 50,
                                           format = colFormat(separators = TRUE,
                                                              digits = 0))
        ),
        columnGroups = list(
            colGroup(name = "Чеки", columns = c("total_checks",
                                                "total_checks_change",
                                                "one_item_checks_share",
                                                "share_regular_cust")),
            colGroup(name = "Середній чек", columns = c("avr_check_sum",
                                                       "avr_check_change")),
            colGroup(name = "Характеристики чека", columns = c("avr_check_sku",
                                                               "avr_unit_sum")),
            colGroup(name = "Бонуси", columns = c("reg_cust_bonus_acrrued",
                                                  "reg_cust_bonus_reduced"))
            ),
        bordered = TRUE
    )
```

Персонал {data-icon="fa-user"}
=======================================================================

Row {data-height=150}
-----------------------------------------------------------------------

### GMROL(1год)

```{r}
valueBox(
  value = total_gmrol,
  icon  = "fa-user",
  color = "primary"
)
```

### Сервіс-фактор (чеки/особа)

```{r}
valueBox(
  value = format(total_service_factor, big.mark="'"),
  icon  = "fa-receipt",
  color = "primary"
)
```

### Площа, що обслуговується (м^2^/особа)

```{r}
valueBox(
  value = total_area_served,
  icon  = "fa-chart-pie",
  color = "primary"
)
```

Row {data-height=400}
-----------------------------------------------------------------------

### GMROL (грн/год) {data-width=400}

```{r}
retail_df %>% 
    select(subdiv_name, gmrol) %>% 
    filter(subdiv_name != "ВСЕГО") %>% 
    arrange(gmrol) %>% 
    filter(between(row_number(), 1, 3) | between(row_number(),total_shops-2,
                                                 total_shops)) %>%
    mutate(type = ifelse(row_number() <= 3,
                         "bottom",
                         "top")) %>% 
    ggplot(aes(x = reorder(subdiv_name, gmrol), y = gmrol, fill = type)) +
    geom_col() +
    geom_text(aes(label = gmrol, y = gmrol / 2), size = 4.5) +
    scale_fill_manual(values = c("salmon", "yellowgreen")) +
    labs(x = "", y = "") +
    coord_flip() +
    theme_minimal() +
    theme(legend.position="none",
          axis.text.y = element_text(size = 14),
          axis.text.x = element_blank(),
          panel.grid = element_blank())
```

### Сервіс-фактор (кількість чеків на 1особу) {data-width=400}

```{r}
retail_df %>% 
    select(subdiv_name, service_factor) %>% 
    filter(subdiv_name != "ВСЕГО") %>% 
    arrange(service_factor) %>% 
    filter(between(row_number(), 1, 3) | between(row_number(),total_shops-2,
                                                 total_shops)) %>%
    mutate(type = ifelse(row_number() <= 3,
                         "bottom",
                         "top")) %>% 
    ggplot(aes(x = reorder(subdiv_name, service_factor),
               y = service_factor, fill = type)) +
    geom_col() +
    geom_text(aes(label = service_factor, y = service_factor / 2), size = 4.5) +
    scale_fill_manual(values = c("salmon", "yellowgreen")) +
    labs(x = "", y = "") +
    coord_flip() +
    theme_minimal() +
    theme(legend.position="none",
          axis.text.y = element_text(size = 14),
          axis.text.x = element_blank(),
          panel.grid = element_blank())
```

### Площа, що обслуговується (торг.площа на 1 робітника) {data-width=400}

```{r}
retail_df %>% 
    select(subdiv_name, area_served) %>% 
    filter(subdiv_name != "ВСЕГО") %>% 
    arrange(area_served) %>% 
    filter(between(row_number(), 1, 3) | between(row_number(),total_shops-2,
                                                 total_shops)) %>%
    mutate(type = ifelse(row_number() <= 3,
                         "bottom",
                         "top")) %>% 
    ggplot(aes(x = reorder(subdiv_name, area_served), y = area_served,
               fill = type)) +
    geom_col() +
    geom_text(aes(label = area_served, y = area_served / 2), size = 4.5) +
    scale_fill_manual(values = c("salmon", "yellowgreen")) +
    labs(x = "", y = "") +
    coord_flip() +
    theme_minimal() +
    theme(legend.position="none",
          axis.text.y = element_text(size = 14),
          axis.text.x = element_blank(),
          panel.grid = element_blank())
```

Row
-----------------------------------------------------------------------

### Дані {data-width=1000}

```{r}
retail_df %>%
    select(subdiv_name, parent_shop, period_work_time, staff_factor,
           service_factor, gmrol) %>%
    filter(subdiv_name != "ВСЕГО") %>%
    reactable(striped = TRUE,
        groupBy = c("parent_shop"),
        columns = list(
            parent_shop = colDef(name = "Категорія"),
            subdiv_name = colDef(name = "Магазин"),
            period_work_time = colDef(aggregate = "mean",
                                      name = "Кіл.роб.годин",
                                      minWidth = 70,
                                      format = colFormat(separators = TRUE,
                                                digits = 0)),
            staff_factor = colDef(aggregate = "mean",
                                  name = "Фактор укомпл.",
                                  minWidth = 70,
                                  format = colFormat(digits = 1)),
            service_factor = colDef(aggregate = "mean",
                                    name = "Сервіс-фактор",
                                    minWidth = 70,
                                    format = colFormat(digits = 0)),
            
            gmrol = colDef(name = "GMROL(год)",
                           aggregate = "mean",
                           minWidth = 60, 
                           cell = color_tiles(.,
                                              number_fmt = scales::label_comma(big.mark = " "),
                                              colors = c('salmon',
                                                         'white',
                                                         'yellowgreen')),
                           format = colFormat(digits = 0))
        ),
    bordered = TRUE
    )
```


Асортимент {data-icon="fa-dolly"}
=======================================================================

Row {data-height=500}
-----------------------------------------------------------------------

### Виторг та валовий прибуток за категор.напрямками (з рентабельністю) {data-width=500}

```{r}
sale_category %>% 
    group_by(category_name) %>% 
    summarise(total_sale = sum(category_sale_sum),
              total_cost = sum(category_cost_sum)) %>% 
    mutate(cat_profit = total_sale - total_cost,
           cat_profitability = round(cat_profit / total_sale, 3)) %>% 
    ggplot(aes(x = category_name, label = scales::percent(cat_profitability,
                                                          accuracy = 0.1))) +
    geom_col(aes(y = total_sale, fill = "Виторг")) +
    geom_col(aes(y = cat_profit, fill = "Вал.прибуток")) +
    geom_text(aes(y = cat_profit), size = 2.5) +
    coord_flip() +
    scale_y_continuous(label = scales::comma) +
    labs(x = "", y = "", fill = "") +
    theme_minimal() +
    theme(legend.position = "top",
          axis.text.x = element_text(size = 7),
          axis.text.y = element_text(size = 7),
          legend.text = element_text(size = 7),
          legend.spacing.x = unit(0.8, 'cm'),
          legend.text.align = 0.5,
          panel.grid.major.y = element_blank()
          ) +
    scale_fill_manual(values = c(
                                 "Виторг" = "cornflowerblue",
                                 "Вал.прибуток" = "darkgrey"))
```

### АВС аналіз продажу {data-width=500}

```{r}
plotly::ggplotly(g, tooltip = "text")
```

Row {data-height=500}
-----------------------------------------------------------------------

### Кількість проданих SKU по магазинам {data-width=500}

```{r}
plotly::ggplotly(p, tooltip = "y")
```

### Найпопулярніші товари за кількістю чеків (кількість магазинів) {data-width=500}

```{r}
items_df %>% 
    slice_max(item_checks, n = 15) %>% 
    ggplot(aes(x = reorder(item_name, item_checks), y = item_checks,
               label = subdiv_nmbr)) +
    geom_col(fill = "cornflowerblue") +
    geom_text(aes(y = item_checks / 2)) +
    coord_flip() +
    scale_y_continuous(label = scales::comma) +
    labs(x = "", y = "Кількість чеків") +
    theme_minimal() +
    theme(axis.text.x = element_text(size = 8),
          axis.text.y = element_text(size = 8),
          panel.grid.major.y = element_blank())
```


Дод.інформація {data-icon="fa-chart-line"}
=======================================================================

Row {data-height=500}
-----------------------------------------------------------------------

### Кластеризація магазинів за категор.напрямками у чеках {data-width=500, .no-padding}

```{r}
factoextra::fviz_dend(res.agnes, cex = .45, h = 3.5, horiz = TRUE,
                      k_colors = "jco", rect = TRUE, rect_border = "jco",
                      rect_fill = TRUE,
                      main = "")
```

### Аналіз кількості чеків за часом та днем тижня {data-width=500}

```{r}
checks_time  %>% 
    group_by(week_day, check_time) %>%
    summarise(trans_nbr = n()) %>%
    #filter(!time %in% c("00", "07", "21", "23")) %>% 
    ggplot(aes(week_day, check_time, fill = trans_nbr)) +
    geom_tile() +
    labs(x="", y="", title = "", fill = "Кількість") +
    scale_fill_distiller(palette = "Spectral") +
    theme_minimal() +
    theme(axis.text.x = element_text(size = 12),
          axis.text.y = element_text(size = 12))
```

Row {data-height=500}
-----------------------------------------------------------------------

### Продаж на 1 особу населення (більше коло - більший показник) {data-width=500}

```{r}
library(leaflet)

leaflet(map_df) %>% 
    addProviderTiles("OpenStreetMap.Mapnik") %>% 
    setView(26.41525, 49.84463, zoom = 6.5) %>%
    addCircleMarkers(lat = ~latitude, lng = ~longtitude,
                     radius = ~sqrt(revenue_per_popul) * 3,
                     color = "red",
                     popup = ~paste0(
                         subdiv_town, '<br>',
                         '<b>Населення</b>: ', population, '<br>',
                         '<b>Продаж на особу</b>: ', revenue_per_popul,
                                                              '<b>грн</b>'
                     ))
```

### Конверсія у Хмельницькому супермаркеті: загальна за звітний місяць - `r total_conversion`% {data-width=500}

```{r}
passability_by_day %>%
    filter(day_visitors > 0) %>% 
    ggplot(aes(x = date, label = paste0(n, "\n", scales::percent(conversion,
                                                                 accuracy = 1)
                                        ))) +
    geom_col(aes(y = day_visitors, fill = "Не купили")) +
    geom_col(aes(y = n, fill = "Купили")) +
    geom_text(aes(y = n), size = 2, vjust = 1) +
    scale_x_date(date_breaks = '1 days', 
                 labels = scales::date_format("%d-%b")) +
    scale_y_continuous(label = scales::comma) +
    labs(x = "", y = "", fill = "") +
    theme_minimal() +
    theme(legend.position = "top",
          axis.text.x = element_text(size = 7, angle = 30, hjust = 1, vjust =1),
          axis.text.y = element_text(size = 7),
          legend.text = element_text(size = 6),
          legend.text.align = 0.85,
          legend.spacing.x = unit(0.6, 'cm')

    ) +
    scale_fill_manual(values = c(
        "Не купили" = "orangered",
        "Купили" = "lightgreen"))

```

